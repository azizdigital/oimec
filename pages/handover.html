<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Executive Handover Suite</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@7.8.2/build/index.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1e293b;
            --secondary-color: #475569;
            --accent-color: #e74c3c;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--slate-50);
            color: var(--slate-800);
            line-height: 1.5;
            font-weight: 400;
            min-height: 100vh;
        }

        body.dark-mode {
            --slate-50: #0f172a;
            --slate-100: #1e293b;
            --slate-200: #334155;
            --slate-300: #475569;
            --slate-800: #f1f5f9;
            --slate-700: #e2e8f0;
            --slate-600: #cbd5e1;
            background: #0f172a;
            color: #f1f5f9;
        }

        .module-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header - Professional */
        .module-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--slate-700) 100%);
            color: white;
            padding: 24px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            font-size: 2rem;
            color: white;
        }

        .header-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .module-title {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .module-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            color: var(--slate-300);
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .header-btn {
            padding: 10px 18px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-1px);
        }

        /* NEW: Sync Info Box Styling */
        .sync-info-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(14, 165, 233, 0.1);
        }

        body.dark-mode .sync-info-box {
            background: linear-gradient(135deg, #0c4a6e 0%, #075985 100%);
            border-color: #0284c7;
        }

        .sync-info-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .sync-info-text h4 {
            margin: 0 0 8px 0;
            color: #0c4a6e;
            font-size: 1.1rem;
            font-weight: 600;
        }

        body.dark-mode .sync-info-text h4 {
            color: #e0f2fe;
        }

        .sync-info-text p {
            margin: 0;
            color: #0369a1;
            font-size: 0.9rem;
        }

        body.dark-mode .sync-info-text p {
            color: #bae6fd;
        }

        .sync-timestamp {
            margin: 8px 0 0 0;
            color: #64748b;
            font-size: 0.85rem;
            font-style: italic;
        }

        .synced-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(14, 165, 233, 0.15);
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #0284c7;
            font-weight: 600;
            margin-top: 8px;
        }

        body.dark-mode .synced-indicator {
            background: rgba(14, 165, 233, 0.3);
            color: #38bdf8;
        }

        /* Settings Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .modal-content {
            background: var(--slate-100);
        }

        .modal-header {
            padding: 24px 30px;
            border-bottom: 1px solid var(--slate-200);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        body.dark-mode .modal-title {
            color: var(--slate-700);
        }

        .modal-body {
            padding: 30px;
        }

        .setting-group {
            margin-bottom: 24px;
        }

        .setting-label {
            display: block;
            font-weight: 600;
            color: var(--slate-700);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .setting-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--slate-300);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: white;
            color: var(--slate-800);
            font-family: inherit;
        }

        body.dark-mode .setting-input {
            background: var(--slate-200);
            color: var(--slate-800);
            border-color: var(--slate-300);
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--slate-600);
            box-shadow: 0 0 0 3px rgba(71, 85, 105, 0.1);
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            background: var(--slate-300);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--success-color);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            left: 27px;
        }

        .toggle-label {
            font-size: 0.9rem;
            color: var(--slate-600);
            font-weight: 500;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--slate-200);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Info Bar */
        .info-bar {
            background: white;
            border-bottom: 1px solid var(--slate-200);
            padding: 24px 30px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        body.dark-mode .info-bar {
            background: var(--slate-100);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-item label {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--slate-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .info-item input {
            border: 1px solid var(--slate-300);
            border-radius: 6px;
            padding: 10px 14px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: white;
        }

        body.dark-mode .info-item input {
            background: var(--slate-200);
            color: var(--slate-800);
        }

        .info-item input:focus {
            outline: none;
            border-color: var(--slate-600);
            box-shadow: 0 0 0 3px rgba(71, 85, 105, 0.1);
        }

        .date-range {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .date-range span {
            opacity: 0.7;
            font-weight: 500;
        }

        /* Navigation Tabs - Enhanced */
        .nav-tabs-container {
            background: white;
            border-bottom: 1px solid var(--slate-200);
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--slate-400) var(--slate-100);
        }

        body.dark-mode .nav-tabs-container {
            background: var(--slate-100);
        }

        .nav-tabs-container::-webkit-scrollbar {
            height: 4px;
        }

        .nav-tabs-container::-webkit-scrollbar-track {
            background: var(--slate-100);
        }

        .nav-tabs-container::-webkit-scrollbar-thumb {
            background: var(--slate-400);
            border-radius: 2px;
        }

        .nav-tabs {
            display: flex;
            gap: 0;
            min-width: max-content;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
        }

        .tab-button {
            padding: 18px 24px;
            background: none;
            border: none;
            color: var(--slate-600);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            white-space: nowrap;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-button:hover {
            color: var(--slate-800);
            background: var(--slate-50);
        }

        body.dark-mode .tab-button:hover {
            background: var(--slate-200);
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: var(--slate-50);
            font-weight: 600;
        }

        body.dark-mode .tab-button.active {
            color: var(--slate-700);
            background: var(--slate-200);
        }

        .tab-icon {
            font-size: 1.1rem;
        }

        /* Content Area */
        .content-wrapper {
            flex: 1;
            background: var(--slate-50);
            overflow: auto;
        }

        .content-area {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
        }

        .tab-content {
            display: none;
            padding: 32px;
            background: var(--slate-50);
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--slate-200);
            letter-spacing: -0.02em;
        }

        body.dark-mode .section-title {
            color: var(--slate-700);
        }

        /* SHE Sub-tabs */
        .she-tabs {
            display: flex;
            flex-wrap: wrap;
            background: var(--slate-100);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 24px;
            gap: 2px;
        }

        .she-tab-button {
            padding: 12px 18px;
            color: var(--slate-600);
            cursor: pointer;
            transition: all 0.2s ease;
            background: none;
            border: none;
            font-weight: 500;
            border-radius: 6px;
            font-size: 0.85rem;
            letter-spacing: -0.01em;
            flex: 1;
            text-align: center;
            min-width: 140px;
        }

        .she-tab-button:hover {
            color: var(--slate-800);
            background: rgba(71, 85, 105, 0.08);
        }

        .she-tab-button.active {
            color: white;
            background: var(--slate-600);
            box-shadow: 0 2px 4px rgba(71, 85, 105, 0.3);
            font-weight: 600;
        }

        .she-content {
            display: none;
        }

        .she-content.active {
            display: block;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--slate-700);
            margin-bottom: 8px;
            font-size: 0.9rem;
            letter-spacing: -0.01em;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--slate-300);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: white;
            color: var(--slate-800);
            font-family: inherit;
            line-height: 1.5;
        }

        body.dark-mode .form-control {
            background: var(--slate-200);
            color: var(--slate-800);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--slate-600);
            box-shadow: 0 0 0 3px rgba(71, 85, 105, 0.1);
        }

        .form-help {
            font-size: 0.8rem;
            color: var(--slate-500);
            margin-top: 4px;
            font-weight: 400;
            line-height: 1.4;
        }

        /* Equipment Sections */
        .equipment-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--slate-200);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        body.dark-mode .equipment-section {
            background: var(--slate-100);
        }

        .equipment-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.1rem;
            letter-spacing: -0.01em;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--slate-200);
        }

        body.dark-mode .equipment-title {
            color: var(--slate-700);
        }

        .equipment-grid {
            display: grid;
            gap: 12px;
        }

        .equipment-row {
            display: grid;
            grid-template-columns: 140px 140px 1fr;
            gap: 16px;
            align-items: center;
            padding: 14px 18px;
            background: var(--slate-50);
            border-radius: 8px;
            border: 1px solid var(--slate-200);
            transition: all 0.2s ease;
        }

        .equipment-row:hover {
            border-color: var(--slate-300);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .equipment-label {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--slate-700);
        }

        .status-select {
            padding: 8px 12px;
            border: 1px solid var(--slate-300);
            border-radius: 6px;
            font-size: 0.85rem;
            background: white;
            color: var(--slate-700);
            font-weight: 500;
            transition: all 0.2s ease;
        }

        body.dark-mode .status-select {
            background: var(--slate-200);
            color: var(--slate-800);
        }

        .status-select:focus {
            outline: none;
            border-color: var(--slate-600);
            box-shadow: 0 0 0 2px rgba(71, 85, 105, 0.1);
        }

        .comment-input {
            padding: 8px 12px;
            border: 1px solid var(--slate-300);
            border-radius: 6px;
            font-size: 0.85rem;
            background: white;
            color: var(--slate-700);
            transition: all 0.2s ease;
        }

        body.dark-mode .comment-input {
            background: var(--slate-200);
            color: var(--slate-800);
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--slate-600);
            box-shadow: 0 0 0 2px rgba(71, 85, 105, 0.1);
        }

        .comment-input:disabled {
            background: var(--slate-100);
            color: var(--slate-500);
            border-color: var(--slate-200);
        }

        /* Pigging Items */
        .pigging-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid var(--slate-200);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        body.dark-mode .pigging-item {
            background: var(--slate-100);
        }

        .pigging-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 12px;
            font-size: 1rem;
        }

        body.dark-mode .pigging-title {
            color: var(--slate-700);
        }

        .date-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .date-label {
            font-size: 0.85rem;
            color: var(--slate-600);
            margin-bottom: 6px;
            font-weight: 500;
        }

        /* Safety Defeats */
        .defeat-item {
            background: #fef3cd;
            border: 1px solid #fde68a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .defeat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .defeat-remove {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .defeat-remove:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        /* Buttons */
        .add-comment-btn {
            background: var(--warning-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 16px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(245, 158, 11, 0.3);
        }

        .add-comment-btn:hover {
            background: #d97706;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.4);
        }

        .additional-comments {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        body.dark-mode .additional-comments {
            background: var(--slate-100);
        }

        /* Action Buttons */
        .action-buttons {
            background: white;
            border-top: 1px solid var(--slate-200);
            padding: 24px 32px;
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        body.dark-mode .action-buttons {
            background: var(--slate-100);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            letter-spacing: -0.01em;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--slate-600) 0%, var(--slate-700) 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-color) 0%, #dc2626 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
            color: white;
        }

        .btn-secondary {
            background: var(--slate-300);
            color: var(--slate-700);
        }

        /* Notifications */
        .notification {
            padding: 16px 20px;
            margin: 20px 32px;
            border-radius: 8px;
            display: none;
            font-weight: 500;
            font-size: 0.9rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid;
            position: relative;
        }

        .notification.success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border-color: #22c55e;
        }

        .notification.error {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            color: #991b1b;
            border-color: #ef4444;
        }

        /* Production Grid */
        .production-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            align-items: end;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .header-content, .info-bar, .content-area {
                max-width: 100%;
                padding-left: 20px;
                padding-right: 20px;
            }
            
            .nav-tabs {
                padding: 0 20px;
            }
            
            .tab-content {
                padding: 24px 20px;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .header-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .info-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .she-tabs {
                flex-direction: column;
                gap: 4px;
            }

            .she-tab-button {
                min-width: auto;
                flex: none;
            }

            .equipment-row {
                grid-template-columns: 1fr;
                gap: 12px;
                text-align: left;
            }

            .equipment-label {
                font-weight: 600;
                color: var(--primary-color);
            }

            .date-grid, .grid-2, .production-grid, .defeat-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
                padding: 20px;
            }

            .tab-content {
                padding: 20px 16px;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .sync-info-content {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Focus Styles */
        .form-control:focus,
        .status-select:focus,
        .comment-input:focus,
        .btn:focus,
        .she-tab-button:focus,
        .tab-button:focus {
            outline: 2px solid var(--slate-600);
            outline-offset: 2px;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-4 { margin-top: 1rem; }

        /* AI Assistant Modal Styles */
        .ai-tab-btn {
            color: var(--slate-600);
            font-size: 0.9rem;
        }

        .ai-tab-btn:hover {
            background: rgba(71, 85, 105, 0.1) !important;
            color: var(--slate-800);
        }

        .ai-tab-btn.active {
            background: white !important;
            color: var(--primary-color);
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .ai-tab-btn.active {
            background: var(--slate-200) !important;
            color: var(--slate-800);
        }

        .ai-tab-content {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Scrollbars */

        /* Custom Scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--slate-100);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--slate-400);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--slate-500);
        }
		
		/* Edit button hover effect */
		.form-label button.btn:hover {
			transform: translateY(-1px);
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
		}

		/* Highlight textarea when in edit mode */
		textarea:not([readonly]) {
			animation: pulseEdit 2s infinite;
		}

		@keyframes pulseEdit {
			0%, 100% { border-color: #f59e0b; }
			50% { border-color: #fb923c; }
		}
    </style>
</head>
<body>
    <div class="module-container">
        <!-- Header -->
        <div class="module-header">
            <div class="header-content">
                <div class="header-info">
                    <div class="header-logo">üìã</div>
                    <div class="header-text">
                        <h1 class="module-title">Executive Handover Suite</h1>
                        <p class="module-subtitle">Offshore Operations Management System</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
                    <button class="header-btn" onclick="syncFromOperationPage()">üîÑ Sync from Operation</button>
                    <button class="header-btn" onclick="openAIAssistant()">ü§ñ AI Assistant</button>
					<button class="header-btn" onclick="saveDraft()">üíæ Save Draft</button>
                    <button class="header-btn" onclick="generatePDF()">üìÑ Export PDF</button>
                    <button class="header-btn" onclick="generateWord()">üìù Export Word</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal-overlay" id="settingsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <span style="font-size: 1.5rem;">‚öôÔ∏è</span>
                    <h2 class="modal-title">Settings</h2>
                </div>
                <div class="modal-body">
                    <div class="setting-group">
                        <label class="setting-label">Default "From" Name</label>
                        <input type="text" id="settingFromName" class="setting-input" placeholder="Abd Aziz Mohamad">
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">Default "To" Name</label>
                        <input type="text" id="settingToName" class="setting-input" placeholder="Mohammad Azam Abu Bakar">
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">Default Date Range (days)</label>
                        <input type="number" id="settingDateRange" class="setting-input" placeholder="14" min="1" max="365">
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">Auto-Save Draft</label>
                        <div class="toggle-container">
                            <div class="toggle-switch" id="settingAutoSave" onclick="toggleSwitch(this)">
                                <div class="toggle-slider"></div>
                            </div>
                            <span class="toggle-label">Enable automatic draft saving</span>
                        </div>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">Auto-Save Interval (minutes)</label>
                        <input type="number" id="settingAutoSaveInterval" class="setting-input" placeholder="5" min="1" max="60">
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">Default Export Format</label>
                        <select id="settingExportFormat" class="setting-input">
                            <option value="PDF">PDF</option>
                            <option value="Word">Word</option>
                            <option value="JSON">JSON</option>
                        </select>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">Theme Mode</label>
                        <select id="settingTheme" class="setting-input">
                            <option value="Light">Light</option>
                            <option value="Dark">Dark</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeSettings()">Close</button>
                    <button class="btn btn-success" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>

		<!-- AI Assistant Modal -->
        <div class="modal-overlay" id="aiAssistantModal">
            <div class="modal-content" style="max-width: 800px; max-height: 85vh;">
                <div class="modal-header">
                    <span style="font-size: 1.5rem;">ü§ñ</span>
                    <h2 class="modal-title">AI Assistant - OIM Handover Helper</h2>
                </div>
                
                <!-- AI Tabs -->
                <div style="display: flex; background: var(--slate-100); padding: 4px; margin: 0; border-bottom: 1px solid var(--slate-200);">
                    <button class="ai-tab-btn active" onclick="switchAITab('extract')" style="flex: 1; padding: 10px 16px; background: none; border: none; cursor: pointer; font-weight: 500; border-radius: 6px; transition: all 0.2s; font-size: 0.85rem;">
                        üì§ Upload & Extract
                    </button>
                    <button class="ai-tab-btn" onclick="switchAITab('refine')" style="flex: 1; padding: 10px 16px; background: none; border: none; cursor: pointer; font-weight: 500; border-radius: 6px; transition: all 0.2s; font-size: 0.85rem;">
                        ‚ú® Refine Writing
                    </button>
                    <button class="ai-tab-btn" onclick="switchAITab('email')" style="flex: 1; padding: 10px 16px; background: none; border: none; cursor: pointer; font-weight: 500; border-radius: 6px; transition: all 0.2s; font-size: 0.85rem;">
                        üìß Generate Email
                    </button>
                </div>

                <div class="modal-body" style="padding: 20px 24px; max-height: calc(85vh - 140px); overflow-y: auto;">
                    <!-- Tab 1: Upload JSON & Extract -->
                    <div id="aiExtractTab" class="ai-tab-content" style="display: block;">
                        <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0ea5e9; border-radius: 8px; padding: 14px; margin-bottom: 16px;">
                            <h4 style="margin: 0 0 6px 0; color: #0c4a6e; font-size: 0.95rem; font-weight: 600;">üìã Upload OIM Assist JSON File</h4>
                            <p style="margin: 0; color: #0369a1; font-size: 0.8rem;">Upload your JSON file to generate a professional OIM handover note</p>
                        </div>

                        <div class="form-group" style="margin-bottom: 16px;">
                            <label class="form-label" style="font-size: 0.85rem;">Select JSON File:</label>
                            <input type="file" id="jsonFileInput" accept=".json" class="form-control" style="padding: 8px; font-size: 0.85rem;">
                        </div>

                        <div id="jsonPreview" style="display: none; margin-top: 12px;">
                            <label class="form-label" style="font-size: 0.85rem;">File Preview:</label>
                            <div style="background: var(--slate-50); border: 1px solid var(--slate-300); border-radius: 6px; padding: 10px; max-height: 150px; overflow-y: auto;">
                                <pre id="jsonPreviewText" style="margin: 0; font-size: 0.75rem; white-space: pre-wrap; word-wrap: break-word;"></pre>
                            </div>
                        </div>

                        <div style="margin-top: 16px; padding: 14px; background: var(--slate-50); border-radius: 8px; border: 1px solid var(--slate-200);">
                            <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--slate-700); font-weight: 600;">üìù Generated AI Prompt:</h4>
                            <textarea id="aiExtractPrompt" class="form-control" rows="8" readonly style="font-size: 0.8rem; font-family: 'Courier New', monospace; background: white;"></textarea>
                            <button onclick="copyToClipboard('aiExtractPrompt')" class="btn btn-primary" style="margin-top: 10px; width: 100%; font-size: 0.85rem;">
                                üìã Copy Prompt to Clipboard
                            </button>
                        </div>
                    </div>

                    <!-- Tab 2: Refine Writing -->
                    <div id="aiRefineTab" class="ai-tab-content" style="display: none;">
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 8px; padding: 14px; margin-bottom: 16px;">
                            <h4 style="margin: 0 0 6px 0; color: #78350f; font-size: 0.95rem; font-weight: 600;">‚ú® Refine Your Writing</h4>
                            <p style="margin: 0; color: #92400e; font-size: 0.8rem;">Auto-extract text from current system data and refine it</p>
                        </div>

                        <div class="form-group" style="margin-bottom: 14px;">
                            <button onclick="useCurrentSystemData()" class="btn btn-success" style="width: 100%; margin-bottom: 12px; font-size: 0.85rem;">
                                üîÑ Auto-Extract Text from System
                            </button>
                        </div>

                        <div class="form-group" style="margin-bottom: 16px;">
                            <label class="form-label" style="font-size: 0.85rem;">Text to Refine:</label>
                            <textarea id="textToRefine" class="form-control" rows="6" placeholder="Your text will appear here after clicking 'Auto-Extract' or you can paste your own text..." style="font-size: 0.85rem;"></textarea>
                        </div>

                        <div style="margin-top: 16px; padding: 14px; background: var(--slate-50); border-radius: 8px; border: 1px solid var(--slate-200);">
                            <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--slate-700); font-weight: 600;">üìù Generated AI Prompt:</h4>
                            <textarea id="aiRefinePrompt" class="form-control" rows="7" readonly style="font-size: 0.8rem; font-family: 'Courier New', monospace; background: white;"></textarea>
                            <button onclick="copyToClipboard('aiRefinePrompt')" class="btn btn-primary" style="margin-top: 10px; width: 100%; font-size: 0.85rem;">
                                üìã Copy Prompt to Clipboard
                            </button>
                        </div>
                    </div>

                    <!-- Tab 3: Generate Handover Email -->
                    <div id="aiEmailTab" class="ai-tab-content" style="display: none;">
                        <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border: 2px solid #10b981; border-radius: 8px; padding: 14px; margin-bottom: 16px;">
                            <h4 style="margin: 0 0 6px 0; color: #065f46; font-size: 0.95rem; font-weight: 600;">üìß Generate Handover Email</h4>
                            <p style="margin: 0; color: #047857; font-size: 0.8rem;">Create professional handover email from Aziz to Azam</p>
                        </div>

                        <div class="form-group" style="margin-bottom: 14px;">
                            <button onclick="useCurrentSystemData()" class="btn btn-success" style="width: 100%; margin-bottom: 12px; font-size: 0.85rem;">
                                üîÑ Use Current System Data
                            </button>
                        </div>

                        <div class="form-group" style="margin-bottom: 16px;">
                            <label class="form-label" style="font-size: 0.85rem;">Handover Summary:</label>
                            <textarea id="emailSummary" class="form-control" rows="6" placeholder="Summary will appear here after clicking 'Use Current System Data' or paste your summary..." style="font-size: 0.85rem;"></textarea>
                        </div>

                        <div style="margin-top: 16px; padding: 14px; background: var(--slate-50); border-radius: 8px; border: 1px solid var(--slate-200);">
                            <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--slate-700); font-weight: 600;">üìù Generated AI Prompt:</h4>
                            <textarea id="aiEmailPrompt" class="form-control" rows="7" readonly style="font-size: 0.8rem; font-family: 'Courier New', monospace; background: white;"></textarea>
                            <button onclick="copyToClipboard('aiEmailPrompt')" class="btn btn-primary" style="margin-top: 10px; width: 100%; font-size: 0.85rem;">
                                üìã Copy Prompt to Clipboard
                            </button>
                        </div>
                    </div>
                </div>

                <div class="modal-footer" style="padding: 16px 24px;">
                    <button class="btn btn-secondary" onclick="closeAIAssistant()">Close</button>
                </div>
            </div>
        </div>
		
        <!-- Info Bar -->
        <div class="info-bar">
            <div class="info-grid">
                <div class="info-item">
                    <label>From:</label>
                    <input type="text" id="fromPerson" value="Abd Aziz Mohamad">
                </div>
                <div class="info-item">
                    <label>To:</label>
                    <input type="text" id="toPerson" value="Mohammad Azam Abu Bakar">
                </div>
                <div class="info-item">
                    <label>Date Range:</label>
                    <div class="date-range">
                        <input type="date" id="startDate" style="flex: 1;">
                        <span>‚Äî</span>
                        <input type="date" id="endDate" style="flex: 1;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs-container">
            <div class="nav-tabs">
                <button class="tab-button active" data-tab="she">
                    <span class="tab-icon">üõ°Ô∏è</span>SHE
                </button>
                <button class="tab-button" data-tab="integrity">
                    <span class="tab-icon">üîß</span>Integrity
                </button>
                <button class="tab-button" data-tab="equipment">
                    <span class="tab-icon">‚öôÔ∏è</span>Equipment
                </button>
                <button class="tab-button" data-tab="operations">
                    <span class="tab-icon">üè≠</span>Operations
                </button>
                <button class="tab-button" data-tab="work">
                    <span class="tab-icon">üìä</span>Work Mgmt
                </button>
                <button class="tab-button" data-tab="safety">
                    <span class="tab-icon">‚ö†Ô∏è</span>Safety Systems
                </button>
                <button class="tab-button" data-tab="production">
                    <span class="tab-icon">üìà</span>Production
                </button>
                <button class="tab-button" data-tab="maintenance">
                    <span class="tab-icon">üî®</span>Maintenance
                </button>
                <button class="tab-button" data-tab="simops">
                    <span class="tab-icon">üîÑ</span>SIMOPS
                </button>
                <button class="tab-button" data-tab="admin">
                    <span class="tab-icon">üìã</span>Administration
                </button>
                <button class="tab-button" data-tab="alarm">
                    <span class="tab-icon">üö®</span>Alarms
                </button>
            </div>
        </div>

        <div class="notification" id="notification"></div>

        <!-- Content Area -->
        <div class="content-wrapper">
            <div class="content-area">
                <!-- SHE Tab -->
                <div id="she" class="tab-content active">
                    <h3 class="section-title">Safety, Health and Environment (SHE)</h3>
                    
                    <div class="she-tabs">
                        <button class="she-tab-button active" data-she-tab="sheHealth">SHE & Health</button>
                        <button class="she-tab-button" data-she-tab="scenarioManagement">Scenario Management</button>
                        <button class="she-tab-button" data-she-tab="hcrNmSecurity">HCR/NM/Security</button>
                        <button class="she-tab-button" data-she-tab="safetyMeeting">Safety Meeting/Drill</button>
                    </div>

                    <div id="sheHealth" class="she-content active">
                        <div class="form-group">
                            <label class="form-label">SHE & Health Issues:</label>
                            <textarea id="sheHealthText" class="form-control" rows="6" placeholder="No significant SHE issues reported during this hitch. All safety protocols maintained."></textarea>
                            <span class="form-help">Any issues related to SHE and Health</span>
                        </div>
                    </div>

                    <div id="scenarioManagement" class="she-content">
                        <div class="form-group">
                            <label class="form-label">Scenario Management Safeguard:</label>
                            <textarea id="scenarioManagementText" class="form-control" rows="6" placeholder="All scenario management safeguards reviewed and in place. Latest review conducted on [date]."></textarea>
                            <span class="form-help">Date and any highlight related Scenario Management</span>
                        </div>
                    </div>

                    <div id="hcrNmSecurity" class="she-content">
                        <div class="form-group">
                            <label class="form-label">HCR/NM/Security/DOSS/Others:</label>
                            <textarea id="hcrNmSecurityText" class="form-control" rows="6" placeholder="No HCR incidents reported. Security protocols maintained. All DOSS requirements complied."></textarea>
                            <span class="form-help">Summary of any incident related happen and follow up plan</span>
                        </div>
                    </div>

                    <div id="safetyMeeting" class="she-content">
                        <div class="form-group">
                            <label class="form-label">Safety Meeting / Drill / BeOb / Safety Alert:</label>
                            <textarea id="safetyMeetingText" class="form-control" rows="6" placeholder="Weekly safety meetings conducted. Fire drill completed [date]. All safety alerts reviewed and communicated."></textarea>
                            <span class="form-help">Any alert or package reviewed and date and follow up</span>
                        </div>
                    </div>

                    <button class="add-comment-btn" onclick="addComment('she')">Add Additional Comments</button>
                    <div id="she-comments" class="additional-comments" style="display:none;">
                        <label class="form-label">Additional Comments:</label>
                        <textarea id="sheAdditionalText" class="form-control" rows="3" placeholder="Additional comments for SHE section"></textarea>
                    </div>
                </div>

                <!-- Integrity Tab -->
                <div id="integrity" class="tab-content">
                    <h3 class="section-title">Integrity</h3>
                    <div class="form-group">
                        <label class="form-label">Integrity Issues and IPSS Link:</label>
                        <textarea id="integrityText" class="form-control" rows="6" placeholder="Refer PMET & IPSS system. All integrity monitoring systems functioning within acceptable parameters."></textarea>
                        <span class="form-help">Any integrity issue and link to IPSS</span>
                    </div>

                    <button class="add-comment-btn" onclick="addComment('integrity')">Add Additional Comments</button>
                    <div id="integrity-comments" class="additional-comments" style="display:none;">
                        <label class="form-label">Additional Comments:</label>
                        <textarea id="integrityAdditionalText" class="form-control" rows="3" placeholder="Additional comments for Integrity section"></textarea>
                    </div>
                </div>

                <!-- Major Equipment Tab -->
                <div id="equipment" class="tab-content">
                    <h3 class="section-title">Major Equipment Status</h3>
                   
					<div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: 0 4px 6px rgba(14, 165, 233, 0.1);">
						<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
							<div>
								<h4 style="margin: 0 0 8px 0; color: #0c4a6e; font-size: 1.1rem; font-weight: 600;">‚ö° Equipment Data Sync</h4>
								<p style="margin: 0; color: #0369a1; font-size: 0.9rem;">Sync equipment status from Key Equipment Dashboard (Master)</p>
								<p id="lastSyncTime" style="margin: 8px 0 0 0; color: #64748b; font-size: 0.85rem; font-style: italic;">Last synced: Never</p>
							</div>
							<button onclick="syncFromEquipmentDashboard()" class="btn btn-primary" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); padding: 12px 24px; font-size: 0.95rem; box-shadow: 0 4px 6px rgba(14, 165, 233, 0.3);">
								üîÑ Sync from Equipment Dashboard
							</button>
						</div>
					</div>
	
                    <div class="equipment-section">
                        <div class="equipment-title">MOL Pumps</div>
                        <div class="equipment-grid">
                            <div class="equipment-row">
                                <span class="equipment-label">P-160A:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">P-160B:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">P-160C:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                        </div>
                    </div>

                    <div class="equipment-section">
                        <div class="equipment-title">Generators</div>
                        <div class="equipment-grid">
                            <div class="equipment-row">
                                <span class="equipment-label">TG-410B:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">TG-410C:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">G-500 Emergency Gen:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                        </div>
                    </div>

                    <div class="equipment-section">
                        <div class="equipment-title">Gas Compressor</div>
                        <div class="equipment-grid">
                            <div class="equipment-row">
                                <span class="equipment-label">SK-175:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                        </div>
                    </div>

                    <div class="equipment-section">
                        <div class="equipment-title">Cranes</div>
                        <div class="equipment-grid">
                            <div class="equipment-row">
                                <span class="equipment-label">IbA ME-400:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">IbA ME-450:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">IbB ME-290:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">IbC ME-290:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                        </div>
                    </div>

                    <div class="equipment-section">
                        <div class="equipment-title">Fire Water Pumps</div>
                        <div class="equipment-grid">
                            <div class="equipment-row">
                                <span class="equipment-label">P-590A:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">P-590B:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">P-590C:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                        </div>
                    </div>

                    <!-- Utility Equipment Section -->
                    <div class="equipment-section">
                        <div class="equipment-title">Utility Equipment</div>
                        
                        <div style="margin-bottom: 16px; font-weight: 600; color: var(--slate-700); font-size: 0.95rem;">Instrument Air Compressor:</div>
                        <div class="equipment-grid">
                            <div class="equipment-row">
                                <span class="equipment-label">C-510A:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">C-510B:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                        </div>

                        <div style="margin: 16px 0; font-weight: 600; color: var(--slate-700); font-size: 0.95rem;">Starting Air Compressor:</div>
                        <div class="equipment-grid">
                            <div class="equipment-row">
                                <span class="equipment-label">C-520A:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">C-520B:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                        </div>

                        <div style="margin: 16px 0; font-weight: 600; color: var(--slate-700); font-size: 0.95rem;">Other Utility Equipment:</div>
                        <div class="equipment-grid">
                            <div class="equipment-row">
                                <span class="equipment-label">Air Dryer ME-550:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">P-800A Drain:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">P-800B Drain:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">Water Maker:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">P-830A Potable:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                            <div class="equipment-row">
                                <span class="equipment-label">P-830B Potable:</span>
                                <select class="status-select">
                                    <option value="Available">Available</option>
                                    <option value="Online">Online</option>
                                    <option value="Not Available">Not Available</option>
                                    <option value="Deficient">Deficient</option>
                                </select>
                                <input type="text" class="comment-input" placeholder="Comments (if not available/deficient)" disabled>
                            </div>
                        </div>
                    </div>

                    <button class="add-comment-btn" onclick="addComment('equipment')">Add Additional Comments</button>
                    <div id="equipment-comments" class="additional-comments" style="display:none;">
                        <label class="form-label">Additional Comments:</label>
                        <textarea id="equipmentAdditionalText" class="form-control" rows="3" placeholder="Additional comments for Equipment section"></textarea>
                    </div>
                </div>

                <!-- Operations Tab -->
                <div id="operations" class="tab-content">
                    <h3 class="section-title">Operations</h3>
                    
                    <!-- NEW: Operation Page Sync Info Box -->
                    <div class="sync-info-box" id="operationSyncInfo" style="display: none;">
                        <div class="sync-info-content">
                            <div class="sync-info-text">
                                <h4>‚ö° Data Synced from Operation Page</h4>
                                <p>Operation Issues, Field Changes, and Pigging data have been imported</p>
                                <p class="sync-timestamp" id="operationSyncTimestamp">Last synced: Never</p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">General Operations Information:</label>
                        <textarea id="generalOperationsText" class="form-control" rows="4" placeholder="Update on current operations activities and remarks"></textarea>
                    </div>

					<!-- NEW: Operation Issues from Operation Page -->
					<div class="form-group">
						<label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
							<span>üìã Operation Issues: <span class="synced-indicator" id="operationIssuesIndicator" style="display: none;">üîÑ Synced from Operation Page</span></span>
							<button type="button" onclick="toggleEditMode('operationIssuesFromOps')" class="btn" style="padding: 6px 12px; font-size: 0.8rem; background: var(--slate-300); color: var(--slate-700);">
								‚úèÔ∏è Edit
							</button>
						</label>
						<textarea id="operationIssuesFromOps" class="form-control" rows="4" placeholder="Operation issues will appear here when synced from Operation Page, or you can type manually..." readonly style="background: var(--slate-50);"></textarea>
						<span class="form-help">Synced automatically from Operation Page, or click Edit to add manually</span>
					</div>

					<!-- NEW: Field Changes from Operation Page -->
					<div class="form-group">
						<label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
							<span>üîß Field Changes: <span class="synced-indicator" id="fieldChangesIndicator" style="display: none;">üîÑ Synced from Operation Page</span></span>
							<button type="button" onclick="toggleEditMode('fieldChangesFromOps')" class="btn" style="padding: 6px 12px; font-size: 0.8rem; background: var(--slate-300); color: var(--slate-700);">
								‚úèÔ∏è Edit
							</button>
						</label>
						<textarea id="fieldChangesFromOps" class="form-control" rows="4" placeholder="Field changes will appear here when synced from Operation Page, or you can type manually..." readonly style="background: var(--slate-50);"></textarea>
						<span class="form-help">Synced automatically from Operation Page, or click Edit to add manually</span>
					</div>

                    <div class="form-group">
                        <h4 style="font-size: 1.1rem; font-weight: 600; color: var(--primary-color); margin-bottom: 20px;">Pigging Activity and Schedule</h4>
                        
                        <div class="pigging-item">
                            <div class="pigging-title">16" IbA-TaP MOL (1M)</div>
                            <div class="date-grid">
                                <div>
                                    <div class="date-label">Last Launch:</div>
                                    <input type="date" class="form-control" onchange="calculateNextDue(this, 1)">
                                </div>
                                <div>
                                    <div class="date-label">Next Due:</div>
                                    <input type="date" class="form-control" readonly style="background: var(--slate-100);">
                                </div>
                            </div>
                        </div>

                        <div class="pigging-item">
                            <div class="pigging-title">6" IbA-IbB MGL pigging (6M)</div>
                            <div class="date-grid">
                                <div>
                                    <div class="date-label">Last Launch:</div>
                                    <input type="date" class="form-control" onchange="calculateNextDue(this, 6)">
                                </div>
                                <div>
                                    <div class="date-label">Next Due:</div>
                                    <input type="date" class="form-control" readonly style="background: var(--slate-100);">
                                </div>
                            </div>
                        </div>

                        <div class="pigging-item">
                            <div class="pigging-title">6" IbA-IbC MGL pigging (6M)</div>
                            <div class="date-grid">
                                <div>
                                    <div class="date-label">Last Launch:</div>
                                    <input type="date" class="form-control" onchange="calculateNextDue(this, 6)">
                                </div>
                                <div>
                                    <div class="date-label">Next Due:</div>
                                    <input type="date" class="form-control" readonly style="background: var(--slate-100);">
                                </div>
                            </div>
                        </div>

                        <div class="pigging-item">
                            <div class="pigging-title">8" IbB-IbA FWS pigging (1M)</div>
                            <div class="date-grid">
                                <div>
                                    <div class="date-label">Last Launch:</div>
                                    <input type="date" class="form-control" onchange="calculateNextDue(this, 1)">
                                </div>
                                <div>
                                    <div class="date-label">Next Due:</div>
                                    <input type="date" class="form-control" readonly style="background: var(--slate-100);">
                                </div>
                            </div>
                        </div>

                        <div class="pigging-item">
                            <div class="pigging-title">12" IbC-IbA FWS pigging (1M)</div>
                            <div class="date-grid">
                                <div>
                                    <div class="date-label">Last Launch:</div>
                                    <input type="date" class="form-control" onchange="calculateNextDue(this, 1)">
                                </div>
                                <div>
                                    <div class="date-label">Next Due:</div>
                                    <input type="date" class="form-control" readonly style="background: var(--slate-100);">
                                </div>
                            </div>
                        </div>

                        <div class="pigging-item">
                            <div class="pigging-title">12" SmA-IbA MOL pigging (1M)</div>
                            <div class="date-grid">
                                <div>
                                    <div class="date-label">Last Launch:</div>
                                    <input type="date" class="form-control" onchange="calculateNextDue(this, 1)">
                                </div>
								<div>
                                    <div class="date-label">Next Due:</div>
                                    <input type="date" class="form-control" readonly style="background: var(--slate-100);">
                                </div>
                            </div>
                        </div>

                        <div class="pigging-item">
                            <div class="pigging-title">6" TaP-IbA MGL pigging (6M)</div>
                            <div class="date-grid">
                                <div>
                                    <div class="date-label">Last Launch:</div>
                                    <input type="date" class="form-control" onchange="calculateNextDue(this, 6)">
                                </div>
								<div>
                                    <div class="date-label">Next Due:</div>
                                    <input type="date" class="form-control" readonly style="background: var(--slate-100);">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="add-comment-btn" onclick="addComment('operations')">Add Additional Comments</button>
                    <div id="operations-comments" class="additional-comments" style="display:none;">
                        <label class="form-label">Additional Comments:</label>
                        <textarea id="operationsAdditionalText" class="form-control" rows="3" placeholder="Additional comments for Operations section"></textarea>
                    </div>
                </div>

                <!-- Work Management Tab -->
                <div id="work" class="tab-content">
                    <h3 class="section-title">Work Management</h3>
                    <div class="form-group">
                        <label class="form-label">Work Management Activities:</label>
                        <textarea id="workManagementText" class="form-control" rows="6" placeholder="All planned maintenance work progressing as scheduled. Work permits managed in accordance with procedures."></textarea>
                        <span class="form-help">Any comment related to work management</span>
                    </div>

                    <button class="add-comment-btn" onclick="addComment('work')">Add Additional Comments</button>
                    <div id="work-comments" class="additional-comments" style="display:none;">
                        <label class="form-label">Additional Comments:</label>
                        <textarea id="workAdditionalText" class="form-control" rows="3" placeholder="Additional comments for Work Management section"></textarea>
                    </div>
                </div>

                <!-- Safety Systems Tab -->
                <div id="safety" class="tab-content">
                    <h3 class="section-title">Safety Systems Defeated (Temporary Defeats)</h3>
                    
                    <!-- NEW: Safety Defeats Sync Info -->
                    <div class="sync-info-box" id="defeatsSyncInfo" style="display: none;">
                        <div class="sync-info-content">
                            <div class="sync-info-text">
                                <h4>‚ö° Safety Defeats Synced from Operation Page</h4>
                                <p id="defeatsSyncCount">0 defeats imported</p>
                                <p class="sync-timestamp" id="defeatsSyncTimestamp">Last synced: Never</p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button id="addDefeatBtn" class="btn btn-warning">Add Safety System Defeat</button>
                    </div>

                    <div id="defeatsContainer">
                        <!-- Dynamic defeats will be added here -->
                    </div>

                    <div class="form-group">
                        <label class="form-label">General Safety Systems Information:</label>
                        <textarea id="safetySystemsText" class="form-control" rows="4" placeholder="No safety systems currently defeated. All safety systems operational."></textarea>
                        <span class="form-help">Any additional safety systems information</span>
                    </div>

                    <button class="add-comment-btn" onclick="addComment('safety')">Add Additional Comments</button>
                    <div id="safety-comments" class="additional-comments" style="display:none;">
                        <label class="form-label">Additional Comments:</label>
                        <textarea id="safetyAdditionalText" class="form-control" rows="3" placeholder="Additional comments for Safety Systems section"></textarea>
                    </div>
                </div>

                <!-- Production Tab -->
                <div id="production" class="tab-content">
                    <h3 class="section-title">Production Issues</h3>
                    
                    <!-- NEW: SDC Sync Info -->
                    <div class="sync-info-box" id="sdcSyncInfo" style="display: none;">
                        <div class="sync-info-content">
                            <div class="sync-info-text">
                                <h4>‚ö° SDC Data Synced from Operation Page</h4>
                                <p id="sdcSyncDetails">SDC information imported</p>
                                <p class="sync-timestamp" id="sdcSyncTimestamp">Last synced: Never</p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">SDC Target and Date:</label>
                        <div class="production-grid">
                            <input type="number" id="sdcValue" class="form-control" placeholder="Enter SDC target (kl/d)" step="0.1">
                            <input type="date" id="sdcDate" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Wells Status:</label>
                        <textarea id="wellsStatusText" class="form-control" rows="4" placeholder="All wells operating within normal parameters"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Additional Production Comments:</label>
                        <textarea id="productionCommentsText" class="form-control" rows="3" placeholder="Any additional production-related comments"></textarea>
                    </div>

                    <button class="add-comment-btn" onclick="addComment('production')">Add Additional Comments</button>
                    <div id="production-comments" class="additional-comments" style="display:none;">
                        <label class="form-label">Additional Comments:</label>
                        <textarea id="productionAdditionalText" class="form-control" rows="3" placeholder="Additional comments for Production section"></textarea>
                    </div>
                </div>

                <!-- Maintenance Tab -->
                <div id="maintenance" class="tab-content">
                    <h3 class="section-title">Maintenance</h3>
                    <div class="form-group">
                        <label class="form-label">Maintenance Activities:</label>
                        <textarea id="maintenanceText" class="form-control" rows="6" placeholder="All scheduled maintenance activities completed. Preventive maintenance on track."></textarea>
                        <span class="form-help">Any maintenance relevant activities</span>
                    </div>

                    <button class="add-comment-btn" onclick="addComment('maintenance')">Add Additional Comments</button>
                    <div id="maintenance-comments" class="additional-comments" style="display:none;">
                        <label class="form-label">Additional Comments:</label>
                        <textarea id="maintenanceAdditionalText" class="form-control" rows="3" placeholder="Additional comments for Maintenance section"></textarea>
                    </div>
                </div>

                <!-- SIMOPS Tab -->
                <div id="simops" class="tab-content">
                    <h3 class="section-title">SIMOPS</h3>
                    <div class="form-group">
                        <label class="form-label">SIMOPS Activities:</label>
                        <textarea id="simopsText" class="form-control" rows="6" placeholder="No simultaneous operations planned for next hitch. Workgroup coordination maintained."></textarea>
                    </div>

                    <button class="add-comment-btn" onclick="addComment('simops')">Add Additional Comments</button>
                    <div id="simops-comments" class="additional-comments" style="display:none;">
                        <label class="form-label">Additional Comments:</label>
                        <textarea id="simopsAdditionalText" class="form-control" rows="3" placeholder="Additional comments for SIMOPS section"></textarea>
                    </div>
                </div>

                <!-- Administration Tab -->
                <div id="admin" class="tab-content">
                    <h3 class="section-title">Administration / New Directives / New Procedures/Staffing</h3>
                    <div class="form-group">
                        <label class="form-label">Administrative Updates:</label>
                        <textarea id="administrationText" class="form-control" rows="6" placeholder="No new directives received. All procedures current. Staffing levels adequate."></textarea>
                    </div>

                    <button class="add-comment-btn" onclick="addComment('admin')">Add Additional Comments</button>
                    <div id="admin-comments" class="additional-comments" style="display:none;">
                        <label class="form-label">Additional Comments:</label>
                        <textarea id="adminAdditionalText" class="form-control" rows="3" placeholder="Additional comments for Administration section"></textarea>
                    </div>
                </div>

                <!-- Alarm Management Tab -->
                <div id="alarm" class="tab-content">
                    <h3 class="section-title">Alarm Management</h3>
                    <div class="form-group">
                        <label class="form-label">Active Alarms and Restoration Plan:</label>
                        <textarea id="alarmManagementText" class="form-control" rows="6" placeholder="All alarm systems functioning properly. No standing alarms requiring attention."></textarea>
                    </div>

                    <button class="add-comment-btn" onclick="addComment('alarm')">Add Additional Comments</button>
                    <div id="alarm-comments" class="additional-comments" style="display:none;">
                        <label class="form-label">Additional Comments:</label>
                        <textarea id="alarmAdditionalText" class="form-control" rows="3" placeholder="Additional comments for Alarm Management section"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button id="saveDraftBtn" class="btn btn-primary">üíæ Save Draft</button>
            <button id="saveAllBtn" class="btn btn-success">üìÑ Export JSON</button>
            <button id="loadBtn" class="btn btn-success">üìÇ Load Data</button>
            <button id="clearBtn" class="btn btn-danger">üóëÔ∏è Clear Form</button>
            <button id="pdfBtn" class="btn btn-primary">üìÑ Generate PDF</button>
            <button id="wordBtn" class="btn btn-primary">üìù Generate Word</button>
            <button id="downloadBtn" class="btn btn-success">üìÑ Download TXT</button>
        </div>
    </div>

    <script>
        // Initialize jsPDF and docx
        window.jsPDF = window.jspdf?.jsPDF;
        let defeatCounter = 0;
        let autoSaveInterval = null;

        // NEW: Sync from Operation Page Function
        function syncFromOperationPage() {
            try {
                // Get data from localStorage
                const operationDataStr = localStorage.getItem('operationToHandoverData');
                
                if (!operationDataStr) {
                    showNotification('‚ùå No operation data found! Please open Operation Page and click "Sync to Handover" first.', 'error');
                    return;
                }
                
                const operationData = JSON.parse(operationDataStr);
                const syncTime = new Date(operationData.timestamp).toLocaleString();
                
                // Build summary of what will be synced
                let summaryItems = [];
                if (operationData.sdc && operationData.sdc.value) {
                    summaryItems.push(`‚úÖ SDC: ${operationData.sdc.value} kl/d`);
                }
                if (operationData.pigging && operationData.pigging.length > 0) {
                    const piggingWithDates = operationData.pigging.filter(p => p.lastDone || p.nextSchedule).length;
                    summaryItems.push(`‚úÖ Pigging: ${piggingWithDates} activities with dates`);
                }
                if (operationData.defeats && operationData.defeats.length > 0) {
                    summaryItems.push(`‚úÖ Safety Defeats: ${operationData.defeats.length} active`);
                }
                if (operationData.operationIssues) {
                    summaryItems.push(`‚úÖ Operation Issues`);
                }
                if (operationData.fieldChanges) {
                    summaryItems.push(`‚úÖ Field Changes`);
                }
                
                // Confirm with user
                const confirmMsg = `Sync data from Operation Page?\n\nLast updated: ${syncTime}\n\n${summaryItems.join('\n')}\n\n‚ö†Ô∏è This will overwrite existing data in:\n‚Ä¢ Production tab (SDC)\n‚Ä¢ Operations tab (Pigging, Issues, Changes)\n‚Ä¢ Safety Systems tab (Defeats)\n\nContinue?`;
                
                if (!confirm(confirmMsg)) {
                    return;
                }
                
                let syncedCount = 0;
                
                // 1. Sync SDC Data (Production Tab)
                if (operationData.sdc) {
                    if (operationData.sdc.value) {
                        document.getElementById('sdcValue').value = operationData.sdc.value;
                        syncedCount++;
                    }
                    if (operationData.sdc.date) {
                        document.getElementById('sdcDate').value = operationData.sdc.date;
                    }
                    
                    // Show SDC sync info
                    document.getElementById('sdcSyncInfo').style.display = 'block';
                    document.getElementById('sdcSyncDetails').textContent = `SDC: ${operationData.sdc.value || 'N/A'} kl/d | Date: ${operationData.sdc.date || 'N/A'}`;
                    document.getElementById('sdcSyncTimestamp').textContent = `Last synced: ${syncTime}`;
                }
                
                // 2. Sync Pigging Data (Operations Tab)
                if (operationData.pigging && operationData.pigging.length > 0) {
                    const piggingItems = document.querySelectorAll('.pigging-item');
                    
                    operationData.pigging.forEach((opPig, index) => {
                        if (piggingItems[index]) {
                            const dateInputs = piggingItems[index].querySelectorAll('input[type="date"]');
                            if (opPig.lastDone && dateInputs[0]) {
                                dateInputs[0].value = opPig.lastDone;
                                syncedCount++;
                            }
                            if (opPig.nextSchedule && dateInputs[1]) {
                                dateInputs[1].value = opPig.nextSchedule;
                            }
                        }
                    });
                }
                
                // 3. Sync Operation Issues (Operations Tab) - NEW
                if (operationData.operationIssues) {
                    document.getElementById('operationIssuesFromOps').value = operationData.operationIssues;
                    document.getElementById('operationIssuesIndicator').style.display = 'inline-flex';
                    syncedCount++;
                }
                
                // 4. Sync Field Changes (Operations Tab) - NEW
                if (operationData.fieldChanges) {
                    document.getElementById('fieldChangesFromOps').value = operationData.fieldChanges;
                    document.getElementById('fieldChangesIndicator').style.display = 'inline-flex';
                    syncedCount++;
                }
                
                // Show Operations sync info
                if (operationData.operationIssues || operationData.fieldChanges) {
                    document.getElementById('operationSyncInfo').style.display = 'block';
                    document.getElementById('operationSyncTimestamp').textContent = `Last synced: ${syncTime}`;
                }
                
                // 5. Sync Defeats (Safety Systems Tab)
                if (operationData.defeats && operationData.defeats.length > 0) {
                    // Clear existing defeats first
                    document.getElementById('defeatsContainer').innerHTML = '';
                    defeatCounter = 0;
                    
                    // Add each defeat from operation page
                    operationData.defeats.forEach(opDefeat => {
                        defeatCounter++;
                        const container = document.getElementById('defeatsContainer');
                        
                        const defeatDiv = document.createElement('div');
                        defeatDiv.className = 'defeat-item';
                        defeatDiv.id = `defeat-${defeatCounter}`;
                        
                        defeatDiv.innerHTML = `
                            <button class="defeat-remove" onclick="removeDefeat(${defeatCounter})">√ó</button>
                            <div class="form-group">
                                <label class="form-label">Description (Why need the defeat):</label>
                                <textarea class="form-control defeat-description" rows="3" placeholder="Describe why this defeat is necessary">${opDefeat.description || ''}</textarea>
                            </div>
                            <div class="defeat-grid">
                                <div>
                                    <label class="form-label">Date Unit Defeated:</label>
                                    <input type="date" class="form-control defeat-date" value="${opDefeat.expiryDate || ''}">
                                </div>
                                <div>
                                    <label class="form-label">Next Due Date:</label>
                                    <input type="date" class="form-control defeat-due" value="${opDefeat.expiryDate || ''}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Level of Approval:</label>
                                <select class="form-control defeat-approval">
                                    <option value="">Select approval level</option>
                                    <option value="OIM approval" ${opDefeat.currentApproval === 'OIM approval' ? 'selected' : ''}>OIM approval</option>
                                    <option value="Asset Manager approval" ${opDefeat.currentApproval === 'Asset Manager approval' ? 'selected' : ''}>Asset Manager approval</option>
                                    <option value="Area Manager approval" ${opDefeat.currentApproval === 'Area Manager approval' ? 'selected' : ''}>Area Manager approval</option>
                                    <option value="Engineering approval" ${opDefeat.currentApproval === 'Engineering approval' ? 'selected' : ''}>Engineering approval</option>
                                    <option value="Operations Manager approval" ${opDefeat.currentApproval === 'Operations Manager approval' ? 'selected' : ''}>Operations Manager approval</option>
                                </select>
                            </div>
                        `;
                        
                        container.appendChild(defeatDiv);
                        syncedCount++;
                    });
                    
                    // Show defeats sync info
                    document.getElementById('defeatsSyncInfo').style.display = 'block';
                    document.getElementById('defeatsSyncCount').textContent = `${operationData.defeats.length} defeats imported`;
                    document.getElementById('defeatsSyncTimestamp').textContent = `Last synced: ${syncTime}`;
                }
                
                // Success notification
                showNotification(`‚úÖ Sync completed! ${syncedCount} items updated from Operation Page.`, 'success');
                
                console.log(`‚úÖ Sync successful: ${syncedCount} items synced from Operation Page`);
                
            } catch (error) {
                console.error('Sync error:', error);
                showNotification('‚ùå Error syncing from Operation Page: ' + error.message, 'error');
            }
        }
		
		// Toggle Edit Mode for readonly textareas
		function toggleEditMode(textareaId) {
			const textarea = document.getElementById(textareaId);
			const button = event.target; // Get the button that was clicked
			
			if (!textarea) return;
			
			// Toggle readonly state
			if (textarea.hasAttribute('readonly')) {
				// Enable editing
				textarea.removeAttribute('readonly');
				textarea.style.background = 'white';
				textarea.style.borderColor = '#f59e0b';
				textarea.style.borderWidth = '2px';
				textarea.focus();
				
				// Change button to Save
				button.innerHTML = 'üíæ Save';
				button.style.background = 'var(--success-color)';
				button.style.color = 'white';
				
			} else {
				// Disable editing (save)
				textarea.setAttribute('readonly', 'readonly');
				textarea.style.background = 'var(--slate-50)';
				textarea.style.borderColor = 'var(--slate-300)';
				textarea.style.borderWidth = '1px';
				
				// Change button back to Edit
				button.innerHTML = '‚úèÔ∏è Edit';
				button.style.background = 'var(--slate-300)';
				button.style.color = 'var(--slate-700)';
				
				// Show notification
				showNotification('‚úÖ Changes saved!', 'success');
				
				// Auto-save draft
				saveDraft();
			}
		}

        // Settings Functions
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
            loadSettingsToModal();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function toggleSwitch(element) {
            element.classList.toggle('active');
        }

        function loadSettingsToModal() {
            const settings = JSON.parse(localStorage.getItem('settings') || '{}');
            
            document.getElementById('settingFromName').value = settings.defaultFromName || 'Abd Aziz Mohamad';
            document.getElementById('settingToName').value = settings.defaultToName || 'Mohammad Azam Abu Bakar';
            document.getElementById('settingDateRange').value = settings.defaultDateRange || 14;
            document.getElementById('settingAutoSaveInterval').value = settings.autoSaveInterval || 5;
            document.getElementById('settingExportFormat').value = settings.defaultExportFormat || 'PDF';
            document.getElementById('settingTheme').value = settings.themeMode || 'Light';
            
            const autoSaveToggle = document.getElementById('settingAutoSave');
            if (settings.autoSaveDraft) {
                autoSaveToggle.classList.add('active');
            } else {
                autoSaveToggle.classList.remove('active');
            }
        }

        function saveSettings() {
            const settings = {
                defaultFromName: document.getElementById('settingFromName').value,
                defaultToName: document.getElementById('settingToName').value,
                defaultDateRange: parseInt(document.getElementById('settingDateRange').value) || 14,
                autoSaveDraft: document.getElementById('settingAutoSave').classList.contains('active'),
                autoSaveInterval: parseInt(document.getElementById('settingAutoSaveInterval').value) || 5,
                defaultExportFormat: document.getElementById('settingExportFormat').value,
                themeMode: document.getElementById('settingTheme').value
            };
            
            localStorage.setItem('settings', JSON.stringify(settings));
            applySettings();
            closeSettings();
            showNotification('Settings saved successfully!', 'success');
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('settings') || '{}');
            return settings;
        }

        function applySettings() {
            const settings = loadSettings();
            
            // Apply default names
            if (settings.defaultFromName) {
                document.getElementById('fromPerson').value = settings.defaultFromName;
            }
            if (settings.defaultToName) {
                document.getElementById('toPerson').value = settings.defaultToName;
            }
            
            // Apply date range
            const dateRange = settings.defaultDateRange || 14;
            const today = new Date();
            const endDate = new Date(today);
            endDate.setDate(endDate.getDate() + dateRange);
            
            document.getElementById('startDate').value = today.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            
            // Apply theme
            if (settings.themeMode === 'Dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            // Setup auto-save
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            
            if (settings.autoSaveDraft) {
                const intervalMinutes = settings.autoSaveInterval || 5;
                autoSaveInterval = setInterval(() => {
                    saveDraft();
                    console.log('Auto-saved at', new Date().toLocaleTimeString());
                }, intervalMinutes * 60 * 1000);
            }
        }

        // Initialize application
        function init() {
            // Load and apply settings first
            applySettings();
            
            // Set SDC date
            document.getElementById('sdcDate').value = new Date().toISOString().split('T')[0];

            // Setup event listeners
            setupEventListeners();
            
            // Load draft if available
            loadDraft();
            
            // Check if operation data is available
            checkOperationDataAvailable();
        }

        // NEW: Check if operation data is available on page load
        function checkOperationDataAvailable() {
            const operationDataStr = localStorage.getItem('operationToHandoverData');
            if (operationDataStr) {
                try {
                    const operationData = JSON.parse(operationDataStr);
                    const syncTime = new Date(operationData.timestamp).toLocaleString();
                    console.log(`üìã Operation data available from: ${syncTime}`);
                } catch (error) {
                    console.error('Error reading operation data:', error);
                }
            }
        }

        function setupEventListeners() {
            // Main navigation tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                    
                    // Update active state
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // SHE sub-tab navigation
            document.querySelectorAll('.she-tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-she-tab');
                    switchSheTab(tabId);
                    
                    // Update active state
                    document.querySelectorAll('.she-tab-button').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Equipment status change handlers
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', function() {
                    const row = this.closest('.equipment-row');
                    const commentInput = row.querySelector('.comment-input');
                    const status = this.value;
                    
                    if (status === 'Available' || status === 'Online') {
                        commentInput.disabled = true;
                        commentInput.value = '';
                        commentInput.style.backgroundColor = 'var(--slate-100)';
                    } else {
                        commentInput.disabled = false;
                        commentInput.style.backgroundColor = 'white';
                    }
                });
            });

            // Add defeat button
            document.getElementById('addDefeatBtn').addEventListener('click', addDefeat);

            // Button event listeners
            document.getElementById('saveDraftBtn').addEventListener('click', saveDraft);
            document.getElementById('saveAllBtn').addEventListener('click', saveData);
            document.getElementById('loadBtn').addEventListener('click', loadData);
            document.getElementById('clearBtn').addEventListener('click', clearForm);
            document.getElementById('pdfBtn').addEventListener('click', generatePDF);
            document.getElementById('wordBtn').addEventListener('click', generateWord);
            document.getElementById('downloadBtn').addEventListener('click', downloadTXT);

            // Close modal when clicking outside
            document.getElementById('settingsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSettings();
                }
            });
        }

        function switchTab(tabId) {
            // Hide all tab panes
            document.querySelectorAll('.tab-content').forEach(pane => {
                pane.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.add('active');
            }
        }

        function switchSheTab(tabId) {
            // Hide all SHE content
            document.querySelectorAll('.she-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected SHE content
            const targetContent = document.getElementById(tabId);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        }

        function calculateNextDue(input, monthsToAdd) {
            if (!input.value) return;
            
            const piggingItem = input.closest('.pigging-item');
            const nextDueInput = piggingItem.querySelector('input[readonly]');
            
            const lastDate = new Date(input.value);
            const nextDate = new Date(lastDate);
            nextDate.setMonth(nextDate.getMonth() + monthsToAdd);
            
            nextDueInput.value = nextDate.toISOString().split('T')[0];
        }

        function addComment(sectionId) {
            const commentsDiv = document.getElementById(sectionId + '-comments');
            
            // Show the comments section if hidden
            if (commentsDiv.style.display === 'none') {
                commentsDiv.style.display = 'block';
            }
            
            // Check if there's already a comments container
            let commentsContainer = commentsDiv.querySelector('.comments-container');
            if (!commentsContainer) {
                // Create the comments container if it doesn't exist
                commentsContainer = document.createElement('div');
                commentsContainer.className = 'comments-container';
                
                // Move existing textarea if any
                const existingTextarea = commentsDiv.querySelector('textarea');
                if (existingTextarea && existingTextarea.value) {
                    const firstCommentDiv = createCommentBox(sectionId, existingTextarea.value, 1);
                    commentsContainer.appendChild(firstCommentDiv);
                    existingTextarea.remove();
                }
                
                // Add the container to commentsDiv
                const label = commentsDiv.querySelector('label');
                if (label) label.remove();
                commentsDiv.appendChild(commentsContainer);
                
                // Add button to add more comments
                const addMoreBtn = document.createElement('button');
                addMoreBtn.type = 'button';
                addMoreBtn.className = 'btn btn-warning';
                addMoreBtn.style.cssText = 'margin-top: 12px; padding: 8px 16px; font-size: 0.8rem;';
                addMoreBtn.textContent = '+ Add Another Comment';
                addMoreBtn.onclick = () => addAnotherComment(sectionId);
                commentsDiv.appendChild(addMoreBtn);
            }
            
            // Add the first comment box if container is empty
            if (commentsContainer.children.length === 0) {
                const firstCommentDiv = createCommentBox(sectionId, '', 1);
                commentsContainer.appendChild(firstCommentDiv);
            }
        }

        function createCommentBox(sectionId, initialValue = '', number) {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'additional-comment-box';
            commentDiv.style.cssText = 'margin-bottom: 16px; padding: 16px; background: white; border: 1px solid var(--slate-200); border-radius: 8px; position: relative;';
            
            const commentNumber = number || (document.querySelectorAll(`#${sectionId}-comments .additional-comment-box`).length + 1);
            
            commentDiv.innerHTML = `
                <button type="button" class="comment-remove-btn" onclick="removeComment(this)" style="position: absolute; top: 8px; right: 8px; background: var(--accent-color); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;">√ó</button>
                <label class="form-label" style="margin-bottom: 8px; font-size: 0.85rem;">Additional Comment ${commentNumber}:</label>
                <textarea class="form-control additional-comment-text" rows="3" placeholder="Additional comment ${commentNumber} for ${sectionId.toUpperCase()} section">${initialValue}</textarea>
            `;
            
            return commentDiv;
        }

        function addAnotherComment(sectionId) {
            const commentsContainer = document.querySelector(`#${sectionId}-comments .comments-container`);
            const commentNumber = commentsContainer.children.length + 1;
            const newCommentBox = createCommentBox(sectionId, '', commentNumber);
            commentsContainer.appendChild(newCommentBox);
        }

        function removeComment(button) {
            const commentBox = button.closest('.additional-comment-box');
            const container = commentBox.parentElement;
            commentBox.remove();
            
            // Renumber remaining comments
            const remainingBoxes = container.querySelectorAll('.additional-comment-box');
            remainingBoxes.forEach((box, index) => {
                const label = box.querySelector('label');
                const textarea = box.querySelector('textarea');
                const newNumber = index + 1;
                
                if (label) {
                    label.textContent = `Additional Comment ${newNumber}:`;
                }
                if (textarea) {
                    textarea.placeholder = textarea.placeholder.replace(/\d+/, newNumber);
                }
            });
        }

        function addDefeat() {
            defeatCounter++;
            const container = document.getElementById('defeatsContainer');
            
            const defeatDiv = document.createElement('div');
            defeatDiv.className = 'defeat-item';
            defeatDiv.id = `defeat-${defeatCounter}`;
            
            defeatDiv.innerHTML = `
                <button class="defeat-remove" onclick="removeDefeat(${defeatCounter})">√ó</button>
                <div class="form-group">
                    <label class="form-label">Description (Why need the defeat):</label>
                    <textarea class="form-control defeat-description" rows="3" placeholder="Describe why this defeat is necessary"></textarea>
                </div>
                <div class="defeat-grid">
                    <div>
                        <label class="form-label">Date Unit Defeated:</label>
                        <input type="date" class="form-control defeat-date">
                    </div>
                    <div>
                        <label class="form-label">Next Due Date:</label>
                        <input type="date" class="form-control defeat-due">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Level of Approval:</label>
                    <select class="form-control defeat-approval">
                        <option value="">Select approval level</option>
                        <option value="OIM approval">OIM approval</option>
                        <option value="Asset Manager approval">Asset Manager approval</option>
                        <option value="Area Manager approval">Area Manager approval</option>
                        <option value="Engineering approval">Engineering approval</option>
                        <option value="Operations Manager approval">Operations Manager approval</option>
                    </select>
                </div>
            `;
            
            container.appendChild(defeatDiv);
        }

        function removeDefeat(id) {
            const defeatDiv = document.getElementById(`defeat-${id}`);
            if (defeatDiv) {
                defeatDiv.remove();
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Load draft from localStorage
        function loadDraft() {
            try {
                const savedDraft = localStorage.getItem('handoverDraft');
                if (savedDraft) {
                    const data = JSON.parse(savedDraft);
                    populateFormData(data);
                    showNotification('Draft loaded automatically!', 'success');
                }
            } catch (error) {
                console.error('Error loading draft:', error);
            }
        }

        // Save draft to localStorage
        function saveDraft() {
            try {
                const data = collectAllData();
                localStorage.setItem('handoverDraft', JSON.stringify(data));
                showNotification('Draft saved to local storage!', 'success');
            } catch (error) {
                showNotification('Error saving draft: ' + error.message, 'error');
            }
        }

        function collectAllData() {
            // Helper function to collect multiple additional comments for a section
            function collectAdditionalComments(sectionId) {
                const commentsContainer = document.querySelector(`#${sectionId}-comments .comments-container`);
                if (!commentsContainer) {
                    // Fallback to original single textarea approach
                    const oldTextarea = document.getElementById(sectionId + 'AdditionalText');
                    return oldTextarea && oldTextarea.value ? [oldTextarea.value] : [];
                }
                
                const commentBoxes = commentsContainer.querySelectorAll('.additional-comment-text');
                const comments = [];
                commentBoxes.forEach(textarea => {
                    if (textarea.value.trim()) {
                        comments.push(textarea.value.trim());
                    }
                });
                return comments;
            }

            const data = {
                fromPerson: document.getElementById('fromPerson').value,
                toPerson: document.getElementById('toPerson').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                sheData: {
                    sheHealth: document.getElementById('sheHealthText').value,
                    scenarioManagement: document.getElementById('scenarioManagementText').value,
                    hcrNmSecurity: document.getElementById('hcrNmSecurityText').value,
                    safetyMeeting: document.getElementById('safetyMeetingText').value,
                    additional: collectAdditionalComments('she')
                },
                integrity: document.getElementById('integrityText').value,
                integrityAdditional: collectAdditionalComments('integrity'),
                generalOperations: document.getElementById('generalOperationsText').value,
                operationIssuesFromOps: document.getElementById('operationIssuesFromOps').value || '',
                fieldChangesFromOps: document.getElementById('fieldChangesFromOps').value || '',
                operationsAdditional: collectAdditionalComments('operations'),
                workManagement: document.getElementById('workManagementText').value,
                workAdditional: collectAdditionalComments('work'),
                safetySystemsText: document.getElementById('safetySystemsText').value,
                safetyAdditional: collectAdditionalComments('safety'),
                production: {
                    sdcValue: document.getElementById('sdcValue').value,
                    sdcDate: document.getElementById('sdcDate').value,
                    wellsStatus: document.getElementById('wellsStatusText').value,
                    additionalComments: document.getElementById('productionCommentsText').value,
                    additional: collectAdditionalComments('production')
                },
                maintenance: document.getElementById('maintenanceText').value,
                maintenanceAdditional: collectAdditionalComments('maintenance'),
                simops: document.getElementById('simopsText').value,
                simopsAdditional: collectAdditionalComments('simops'),
                administration: document.getElementById('administrationText').value,
                adminAdditional: collectAdditionalComments('admin'),
                alarmManagement: document.getElementById('alarmManagementText').value,
                alarmAdditional: collectAdditionalComments('alarm'),
                equipment: [],
                pigging: [],
                defeats: []
            };

            // Collect equipment data
            document.querySelectorAll('.equipment-row').forEach(row => {
                const label = row.querySelector('.equipment-label').textContent.replace(':', '');
                const status = row.querySelector('.status-select').value;
                const comment = row.querySelector('.comment-input').value;
                data.equipment.push({ label, status, comment });
            });

            // Collect pigging data
            document.querySelectorAll('.pigging-item').forEach(item => {
                const title = item.querySelector('.pigging-title').textContent;
                const dateInputs = item.querySelectorAll('input[type="date"]');
                const lastLaunch = dateInputs[0].value;
                const nextDue = dateInputs[1].value;
                data.pigging.push({ title, lastLaunch, nextDue });
            });

            // Collect defeats data
            document.querySelectorAll('.defeat-item').forEach(item => {
                const description = item.querySelector('.defeat-description').value;
                const defeatDate = item.querySelector('.defeat-date').value;
                const dueDate = item.querySelector('.defeat-due').value;
                const approval = item.querySelector('.defeat-approval').value;
                if (description || defeatDate || dueDate || approval) {
                    data.defeats.push({ description, defeatDate, dueDate, approval });
                }
            });

            return data;
        }

        function populateFormData(data) {
            // Load basic data
            if (data.fromPerson) document.getElementById('fromPerson').value = data.fromPerson;
            if (data.toPerson) document.getElementById('toPerson').value = data.toPerson;
            if (data.startDate) document.getElementById('startDate').value = data.startDate;
            if (data.endDate) document.getElementById('endDate').value = data.endDate;
            
            // Load SHE data
            if (data.sheData) {
                if (data.sheData.sheHealth) document.getElementById('sheHealthText').value = data.sheData.sheHealth;
                if (data.sheData.scenarioManagement) document.getElementById('scenarioManagementText').value = data.sheData.scenarioManagement;
                if (data.sheData.hcrNmSecurity) document.getElementById('hcrNmSecurityText').value = data.sheData.hcrNmSecurity;
                if (data.sheData.safetyMeeting) document.getElementById('safetyMeetingText').value = data.sheData.safetyMeeting;
                if (data.sheData.additional) {
                    const sheComments = document.getElementById('she-comments');
                    if (sheComments) sheComments.style.display = 'block';
                    const sheAdditional = document.getElementById('sheAdditionalText');
                    if (sheAdditional) sheAdditional.value = data.sheData.additional;
                }
            }
            
            // Load other sections
            if (data.integrity) document.getElementById('integrityText').value = data.integrity;
            if (data.generalOperations) document.getElementById('generalOperationsText').value = data.generalOperations;
            if (data.operationIssuesFromOps) document.getElementById('operationIssuesFromOps').value = data.operationIssuesFromOps;
            if (data.fieldChangesFromOps) document.getElementById('fieldChangesFromOps').value = data.fieldChangesFromOps;
            if (data.workManagement) document.getElementById('workManagementText').value = data.workManagement;
            if (data.safetySystemsText) document.getElementById('safetySystemsText').value = data.safetySystemsText;
            if (data.maintenance) document.getElementById('maintenanceText').value = data.maintenance;
            if (data.simops) document.getElementById('simopsText').value = data.simops;
            if (data.administration) document.getElementById('administrationText').value = data.administration;
            if (data.alarmManagement) document.getElementById('alarmManagementText').value = data.alarmManagement;
            
            // Load production data
            if (data.production) {
                if (data.production.sdcValue) document.getElementById('sdcValue').value = data.production.sdcValue;
                if (data.production.sdcDate) document.getElementById('sdcDate').value = data.production.sdcDate;
                if (data.production.wellsStatus) document.getElementById('wellsStatusText').value = data.production.wellsStatus;
                if (data.production.additionalComments) document.getElementById('productionCommentsText').value = data.production.additionalComments;
            }

            // Load equipment data
            if (data.equipment && data.equipment.length > 0) {
                const equipmentRows = document.querySelectorAll('.equipment-row');
                data.equipment.forEach((item, index) => {
                    if (equipmentRows[index]) {
                        const statusSelect = equipmentRows[index].querySelector('.status-select');
                        const commentInput = equipmentRows[index].querySelector('.comment-input');
                        if (statusSelect) statusSelect.value = item.status;
                        if (commentInput && item.comment) {
                            commentInput.value = item.comment;
                            if (item.status === 'Not Available' || item.status === 'Deficient') {
                                commentInput.disabled = false;
                                commentInput.style.backgroundColor = 'white';
                            }
                        }
                    }
                });
            }

            // Load pigging data
            if (data.pigging && data.pigging.length > 0) {
                const piggingItems = document.querySelectorAll('.pigging-item');
                data.pigging.forEach((pig, index) => {
                    if (piggingItems[index]) {
                        const dateInputs = piggingItems[index].querySelectorAll('input[type="date"]');
                        if (dateInputs[0] && pig.lastLaunch) dateInputs[0].value = pig.lastLaunch;
                        if (dateInputs[1] && pig.nextDue) dateInputs[1].value = pig.nextDue;
                    }
                });
            }

            // Load defeats data
            if (data.defeats && data.defeats.length > 0) {
                data.defeats.forEach(defeat => {
                    addDefeat();
                    const latestDefeat = document.querySelector('.defeat-item:last-child');
                    if (latestDefeat) {
                        if (defeat.description) latestDefeat.querySelector('.defeat-description').value = defeat.description;
                        if (defeat.defeatDate) latestDefeat.querySelector('.defeat-date').value = defeat.defeatDate;
                        if (defeat.dueDate) latestDefeat.querySelector('.defeat-due').value = defeat.dueDate;
                        if (defeat.approval) latestDefeat.querySelector('.defeat-approval').value = defeat.approval;
                    }
                });
            }
        }

        function saveData() {
            try {
                const data = collectAllData();
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `handover_data_${data.startDate || 'current'}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('Data exported successfully!', 'success');
            } catch (error) {
                showNotification('Error saving data: ' + error.message, 'error');
            }
        }

        function loadData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            populateFormData(data);
                            showNotification('Data loaded successfully!', 'success');
                        } catch (error) {
                            showNotification('Error loading data: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearForm() {
            if (confirm('Are you sure you want to clear all form data?')) {
                document.querySelectorAll('input, textarea, select').forEach(input => {
                    if (input.id !== 'fromPerson' && input.id !== 'toPerson') {
                        input.value = '';
                    }
                });
                
                document.getElementById('defeatsContainer').innerHTML = '';
                defeatCounter = 0;
                localStorage.removeItem('handoverDraft');
                
                // Reset dates from settings
                applySettings();
                
                showNotification('Form and draft cleared successfully!', 'success');
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' });
            return new Date(dateStr).toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' });
        }

        // ========================================
        // HELPER FUNCTIONS FOR PDF GENERATION
        // ========================================

        // Text wrapping function for PDF
        function wrapText(text, maxWidth, fontSize, doc) {
            if (!text) return [];
            
            doc.setFontSize(fontSize);
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            
            words.forEach(word => {
                const testLine = currentLine + (currentLine ? ' ' : '') + word;
                const testWidth = doc.getTextWidth(testLine);
                
                if (testWidth > maxWidth && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            });
            
            if (currentLine) {
                lines.push(currentLine);
            }
            
            return lines;
        }

        // Format text for PDF table - handle line breaks properly
        function formatTextForPDFTable(text) {
            if (!text) return '';
            
            text = text.replace(/\n\n+/g, '\n');
            text = text.replace(/[""]/g, '"');
            text = text.replace(/['']/g, "'");
            text = text.replace(/[‚Äî‚Äì]/g, '-');
            text = text.replace(/‚Ä¶/g, '...');
            
            return text.trim();
        }

        // Sanitize text for PDF - remove problematic characters
		function sanitizeTextForPDF(text) {
			if (!text) return '';
			
			return text
				// Remove control characters
				.replace(/[\u0000-\u001F\u007F-\u009F]/g, '')
				
				// Replace common bullets with simple dash
				.replace(/[‚Ä¢‚óè‚óã‚ó¶‚ñ™‚ñ´]/g, '- ')
				
				// Replace various dashes/hyphens with standard dash
				.replace(/[‚Äî‚Äì‚àí]/g, '-')
				
				// Replace quotes
				.replace(/[""]/g, '"')
				.replace(/['']/g, "'")
				
				// Replace ellipsis
				.replace(/‚Ä¶/g, '...')
				
				// Replace special symbols
				.replace(/¬∞/g, ' deg')
				.replace(/¬±/g, '+/-')
				.replace(/√ó/g, 'x')
				.replace(/√∑/g, '/')
				.replace(/‚â§/g, '<=')
				.replace(/‚â•/g, '>=')
				
				// Remove emojis and symbols that cause spacing issues
				.replace(/[\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF]/g, '')
				
				// Fix multiple spaces
				.replace(/\s+/g, ' ')
				
				// Replace remaining non-ASCII characters with space
				.replace(/[^\x20-\x7E\n\r]/g, ' ')
				
				// Clean up extra spaces
				.replace(/\s+/g, ' ')
				.trim();
		}
		
		// Enhanced text cleaning specifically for PDF table content
		function cleanTextForPDFTable(text) {
			if (!text) return '';
			
			return text
				// First, normalize line breaks
				.replace(/\r\n/g, '\n')
				.replace(/\r/g, '\n')
				
				// Replace bullet points at start of lines - KEEP the newline!
				.replace(/^[‚Ä¢‚óè‚óã‚ó¶‚ñ™‚ñ´]\s*/gm, '- ')
				.replace(/\n[‚Ä¢‚óè‚óã‚ó¶‚ñ™‚ñ´]\s*/g, '\n- ')
				
				// Clean up dash bullets - KEEP the newline!
				.replace(/^[‚Äì‚Äî]\s*/gm, '- ')
				.replace(/\n[‚Äì‚Äî]\s*/g, '\n- ')
				
				// Clean special characters but PRESERVE line structure
				.split('\n')
				.map(line => {
					// Only sanitize content, not structure
					return line
						.replace(/[""]/g, '"')
						.replace(/['']/g, "'")
						.replace(/‚Ä¶/g, '...')
						.replace(/¬∞/g, ' deg')
						.replace(/¬±/g, '+/-')
						.replace(/√ó/g, 'x')
						.replace(/√∑/g, '/')
						.replace(/‚â§/g, '<=')
						.replace(/‚â•/g, '>=')
						// Remove emojis but keep text
						.replace(/[\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF]/g, '')
						// Clean up extra spaces within line
						.replace(/\s+/g, ' ')
						.trim();
				})
				.join('\n')  // Rejoin with newlines preserved
				
				// Only remove EXCESSIVE blank lines (3+ blank lines ‚Üí 2 blank lines)
				.replace(/\n\n\n+/g, '\n\n')
				.trim();
		}

		// Automatically clean ALL text data before processing
		function autoCleanData(data) {
			// Deep clone to avoid modifying original
			const cleanedData = JSON.parse(JSON.stringify(data));
			
			// Recursive function to clean all string fields
			const cleanFields = (obj) => {
				for (let key in obj) {
					if (obj[key] === null || obj[key] === undefined) {
						continue; // Skip null/undefined
					}
					
					if (typeof obj[key] === 'string') {
						// Clean the string
						obj[key] = cleanTextForPDFTable(obj[key]);
					} else if (Array.isArray(obj[key])) {
						// If array, clean each element
						obj[key].forEach((item, index) => {
							if (typeof item === 'string') {
								obj[key][index] = cleanTextForPDFTable(item);
							} else if (typeof item === 'object') {
								cleanFields(item); // Recursive for objects in array
							}
						});
					} else if (typeof obj[key] === 'object') {
						// If object, recurse into it
						cleanFields(obj[key]);
					}
				}
			};
			
			cleanFields(cleanedData);
			return cleanedData;
		}

        // Add additional comments to table data
        function addAdditionalCommentsToTable(tableData, additionalComments, sectionName) {
            if (additionalComments && Array.isArray(additionalComments) && additionalComments.length > 0) {
                additionalComments.forEach(function(comment, index) {
                    if (comment && comment.trim()) {
                        const label = additionalComments.length === 1 
                            ? 'Additional Comments' 
                            : 'Additional Comment ' + (index + 1);
                        tableData.push(['', label + ':\n' + sanitizeTextForPDF(formatTextForPDFTable(comment)), '']);
                    }
                });
            }
        }

        // Enhanced PDF Generation with better text handling
        function generatePDF() {
            if (!window.jsPDF) {
                showNotification('PDF library not loaded. Please refresh the page.', 'error');
                return;
            }

            try {
                const rawData = collectAllData();
				const data = autoCleanData(rawData); // Auto-clean ALL text!
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                const contentWidth = pageWidth - (margin * 2);
                
                // Header
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('OFFSHORE HANDOVER NOTES', pageWidth/2, 20, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text('Crew Change Documentation System', pageWidth/2, 28, { align: 'center' });
                
                // Info section
                doc.setFontSize(10);
                let yPos = 40;
                doc.text(`From: ${data.fromPerson || 'Abd Aziz Mohamad'}`, margin, yPos);
                doc.text(`To: ${data.toPerson || 'Mohammad Azam Abu Bakar'}`, margin, yPos + 6);
                doc.text(`Date: ${formatDate(data.startDate)} ‚Äî ${formatDate(data.endDate)}`, margin, yPos + 12);
                
                yPos += 25;
                
                // Note
                doc.setFontSize(8);
                doc.setFont('helvetica', 'italic');
                const noteLines = wrapText('Note: This hand-over format must not be altered without System Administrator\'s approval.', contentWidth, 8, doc);
                noteLines.forEach(line => {
                    doc.text(line, pageWidth/2, yPos, { align: 'center' });
                    yPos += 4;
                });
                
                yPos += 10;

                // Section 1: SHE
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('1. Safety, Health and Environment (SHE)', margin, yPos);
                yPos += 8;
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                const sheSubtitle = 'Provide key SHE information or outstanding work items such as Incidents, Near Misses, Safety Alert Sharing, Safety Meeting & Drill etc';
                const sheSubtitleLines = wrapText(sheSubtitle, contentWidth, 9, doc);
                sheSubtitleLines.forEach(line => {
                    doc.text(line, margin, yPos);
                    yPos += 5;
                });
                yPos += 5;

                // SHE Table with proper text formatting and multiple additional comments
                const sheTableData = [
                    ['No', 'Description', 'Comments'],
                    ['1.', `SHE & Health Issues:\n${sanitizeTextForPDF(formatTextForPDFTable(data.sheData.sheHealth) || 'No issues reported during this hitch.')}`, ''],
                    ['', `Scenario Management Safeguard:\n${sanitizeTextForPDF(formatTextForPDFTable(data.sheData.scenarioManagement) || 'All scenario management safeguards reviewed and in place.')}`, ''],
                    ['', `HCR/NM/Security/DOSS/Others:\n${sanitizeTextForPDF(formatTextForPDFTable(data.sheData.hcrNmSecurity) || 'No HCR incidents reported. Security protocols maintained. All DOSS requirements complied.')}`, ''],
                    ['2.', `Safety Meeting/Drill/BeOb/Safety Alert:\n${sanitizeTextForPDF(formatTextForPDFTable(data.sheData.safetyMeeting) || 'Weekly safety meetings conducted. Fire drills completed. All safety alerts reviewed and communicated.')}`, '']
                ];

                // Add multiple additional comments for SHE
                addAdditionalCommentsToTable(sheTableData, data.sheData.additional, 'SHE');

                doc.autoTable({
                    startY: yPos,
                    head: [sheTableData[0]],
                    body: sheTableData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [30, 41, 59],
                        textColor: [255, 255, 255],
                        fontSize: 10,
                        fontStyle: 'bold'
                    },
                    styles: { 
                        fontSize: 8, 
                        cellPadding: 3,
                        overflow: 'linebreak',
                        columnWidth: 'wrap'
                    },
                    columnStyles: {
                        0: { cellWidth: 15 },
                        1: { cellWidth: contentWidth * 0.65 },
                        2: { cellWidth: contentWidth * 0.2 }
                    },
                    margin: { left: margin, right: margin }
                });

                yPos = doc.lastAutoTable.finalY + 15;

                // Section 2: Integrity
                if (yPos > 230) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('2. Integrity', margin, yPos);
                yPos += 8;

                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                const integritySubtitle = 'Provide key information on Integrity and Reliability example Management of Change';
                const integritySubtitleLines = wrapText(integritySubtitle, contentWidth, 9, doc);
                integritySubtitleLines.forEach(line => {
                    doc.text(line, margin, yPos);
                    yPos += 5;
                });
                yPos += 5;

                const integrityTableData = [
                    ['No', 'Description', 'Comments'],
                    ['1.', sanitizeTextForPDF(formatTextForPDFTable(data.integrity) || 'Refer PMET & IPSS system. All integrity monitoring systems functioning within acceptable parameters.'), '']
                ];

                // Add multiple additional comments for Integrity
                addAdditionalCommentsToTable(integrityTableData, data.integrityAdditional, 'Integrity');

                doc.autoTable({
                    startY: yPos,
                    head: [integrityTableData[0]],
                    body: integrityTableData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [30, 41, 59],
                        textColor: [255, 255, 255],
                        fontSize: 10,
                        fontStyle: 'bold'
                    },
                    styles: { 
                        fontSize: 8, 
                        cellPadding: 3,
                        overflow: 'linebreak'
                    },
                    columnStyles: {
                        0: { cellWidth: 15 },
                        1: { cellWidth: contentWidth * 0.65 },
                        2: { cellWidth: contentWidth * 0.2 }
                    },
                    margin: { left: margin, right: margin }
                });

                yPos = doc.lastAutoTable.finalY + 15;

                // Section 3: Equipment
                if (yPos > 200) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('3. Major Equipment Issues', margin, yPos);
                yPos += 8;

                const equipmentTableData = [['No', 'Description', 'Comments']];
                let counter = 1;

                // Group equipment by category
                const equipmentCategories = {
                    'MOL pumps': data.equipment.filter(item => item.label.startsWith('P-160')),
                    'Generator': data.equipment.filter(item => item.label.startsWith('TG-') || item.label.includes('Gen')),
                    'Gas Compressor': data.equipment.filter(item => item.label.startsWith('SK-')),
                    'Cranes': data.equipment.filter(item => item.label.includes('ME-')),
                    'Fire Water Pumps': data.equipment.filter(item => item.label.startsWith('P-590')),
                    'Utility': data.equipment.filter(item => 
                        !item.label.startsWith('P-160') && 
                        !item.label.startsWith('TG-') && 
                        !item.label.includes('Gen') && 
                        !item.label.startsWith('SK-') && 
                        !item.label.startsWith('P-590') && 
                        !item.label.includes('ME-')
                    )
                };

                Object.entries(equipmentCategories).forEach(([categoryName, items]) => {
                    if (items.length > 0) {
                        equipmentTableData.push([`${counter}.`, categoryName, '']);
                        items.forEach(item => {
                            const desc = `${item.label}: ${item.status}${item.comment ? ` (${item.comment})` : ''}`;
                            equipmentTableData.push(['', desc, '']);
                        });
                        counter++;
                    }
                });

                doc.autoTable({
                    startY: yPos,
                    head: [equipmentTableData[0]],
                    body: equipmentTableData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [30, 41, 59],
                        textColor: [255, 255, 255],
                        fontSize: 10,
                        fontStyle: 'bold'
                    },
                    styles: { 
                        fontSize: 8, 
                        cellPadding: 3,
                        overflow: 'linebreak'
                    },
                    columnStyles: {
                        0: { cellWidth: 15 },
                        1: { cellWidth: contentWidth * 0.65 },
                        2: { cellWidth: contentWidth * 0.2 }
                    },
                    margin: { left: margin, right: margin }
                });

                yPos = doc.lastAutoTable.finalY + 15;

                // Section 4: Operations
                if (yPos > 200) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('4. Operations', margin, yPos);
                yPos += 8;

				const operationsTableData = [
					['No', 'Description', 'Comments'],
					['1.', `General Operations Information:\n${sanitizeTextForPDF(formatTextForPDFTable(data.generalOperations) || 'Operations continuing as per program.')}`, '']
				];

				// Add Operation Issues if exists
				if (data.operationIssuesFromOps) {
					operationsTableData.push(['', `Operation Issues:\n${sanitizeTextForPDF(formatTextForPDFTable(data.operationIssuesFromOps))}`, '']);
				}

				// Add Field Changes if exists
				if (data.fieldChangesFromOps) {
					operationsTableData.push(['', `Field Changes:\n${sanitizeTextForPDF(formatTextForPDFTable(data.fieldChangesFromOps))}`, '']);
				}

				// Add Pigging Activities
				operationsTableData.push(['', 'Pigging Activities:', '']);

				data.pigging.forEach(pig => {
					const desc = `${pig.title}: Last: ${pig.lastLaunch || 'TBD'}, Next: ${pig.nextDue || 'TBD'}`;
					operationsTableData.push(['', desc, '']);
				});

				// Add additional comments for Operations
				addAdditionalCommentsToTable(operationsTableData, data.operationsAdditional, 'Operations');

                doc.autoTable({
                    startY: yPos,
                    head: [operationsTableData[0]],
                    body: operationsTableData.slice(1),
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [30, 41, 59],
                        textColor: [255, 255, 255],
                        fontSize: 10,
                        fontStyle: 'bold'
                    },
                    styles: { 
                        fontSize: 8, 
                        cellPadding: 3,
                        overflow: 'linebreak'
                    },
                    columnStyles: {
                        0: { cellWidth: 15 },
                        1: { cellWidth: contentWidth * 0.65 },
                        2: { cellWidth: contentWidth * 0.2 }
                    },
                    margin: { left: margin, right: margin }
                });

                // Continue with remaining sections (5-11)
                const remainingSections = [
                    { title: "5. Work Management", content: data.workManagement || 'All activities proceeding as planned.' },
                    { title: "6. Safety Systems Defeated", content: data.safetySystemsText || 'No systems defeated.' },
                    { title: "7. Production Issues", content: `Wells: ${data.production.wellsStatus || 'Operating normally'}` },
                    { title: "8. Maintenance", content: data.maintenance || 'All activities on schedule.' },
                    { title: "9. SIMOPS", content: data.simops || 'No operations planned.' },
                    { title: "10. Administration", content: data.administration || 'No new directives.' },
                    { title: "11. Alarm Management", content: data.alarmManagement || 'All systems functioning.' }
                ];

                remainingSections.forEach(section => {
                    yPos = doc.lastAutoTable.finalY + 15;
                    
                    if (yPos > 240) {
                        doc.addPage();
                        yPos = 20;
                    }

                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text(section.title, margin, yPos);
                    yPos += 8;

                    const sectionTableData = [
                        ['No', 'Description', 'Comments'],
                        ['1.', section.content, '']
                    ];

                    doc.autoTable({
                        startY: yPos,
                        head: [sectionTableData[0]],
                        body: sectionTableData.slice(1),
                        theme: 'grid',
                        headStyles: { 
                            fillColor: [30, 41, 59],
                            textColor: [255, 255, 255],
                            fontSize: 10,
                            fontStyle: 'bold'
                        },
                        styles: { 
                            fontSize: 8, 
                            cellPadding: 3,
                            overflow: 'linebreak'
                        },
                        columnStyles: {
                            0: { cellWidth: 15 },
                            1: { cellWidth: contentWidth * 0.65 },
                            2: { cellWidth: contentWidth * 0.2 }
                        },
                        margin: { left: margin, right: margin }
                    });
                });

                // Save PDF
                doc.save(`Enhanced_Handover_${data.startDate || 'Current'}.pdf`);
                showNotification('Enhanced PDF generated successfully with improved formatting!', 'success');

            } catch (error) {
                console.error('PDF generation error:', error);
                showNotification('Error generating PDF: ' + error.message, 'error');
            }
        }

        // Enhanced Word Generation with proper table formatting
			function generateWord() {
				try {
					const rawData = collectAllData();      // ‚úÖ Changed: data ‚Üí rawData
					const data = autoCleanData(rawData);   // ‚úÖ Now this works!
                
                if (typeof docx === 'undefined') {
                    showNotification('Word library not loaded. Please refresh the page.', 'error');
                    return;
                }
                
                const Document = docx.Document;
                const Packer = docx.Packer;
                const Paragraph = docx.Paragraph;
                const TextRun = docx.TextRun;
                const Table = docx.Table;
                const TableCell = docx.TableCell;
                const TableRow = docx.TableRow;
                const WidthType = docx.WidthType;
                const BorderStyle = docx.BorderStyle;
                const HeadingLevel = docx.HeadingLevel;
                const AlignmentType = docx.AlignmentType;
                
                // Helper function to create properly formatted section table
                function createSectionTable(sectionData) {
                    const rows = [
                        new TableRow({
                            children: [
                                new TableCell({ 
                                    children: [new Paragraph({ 
                                        children: [new TextRun({ text: "No", bold: true, size: 20 })] 
                                    })],
                                    width: { size: 10, type: WidthType.PERCENTAGE }
                                }),
                                new TableCell({ 
                                    children: [new Paragraph({ 
                                        children: [new TextRun({ text: "Description", bold: true, size: 20 })] 
                                    })],
                                    width: { size: 70, type: WidthType.PERCENTAGE }
                                }),
                                new TableCell({ 
                                    children: [new Paragraph({ 
                                        children: [new TextRun({ text: "Comments", bold: true, size: 20 })] 
                                    })],
                                    width: { size: 20, type: WidthType.PERCENTAGE }
                                })
                            ]
                        })
                    ];
                    
                    sectionData.forEach(row => {
                        rows.push(new TableRow({
                            children: [
                                new TableCell({ 
                                    children: [new Paragraph({ 
                                        children: [new TextRun({ text: row[0], size: 18 })],
                                        alignment: AlignmentType.LEFT
                                    })],
                                    width: { size: 10, type: WidthType.PERCENTAGE }
                                }),
                                new TableCell({ 
                                    children: [new Paragraph({ 
                                        children: [new TextRun({ text: row[1], size: 18 })],
                                        alignment: AlignmentType.LEFT
                                    })],
                                    width: { size: 70, type: WidthType.PERCENTAGE }
                                }),
                                new TableCell({ 
                                    children: [new Paragraph({ 
                                        children: [new TextRun({ text: row[2], size: 18 })],
                                        alignment: AlignmentType.LEFT
                                    })],
                                    width: { size: 20, type: WidthType.PERCENTAGE }
                                })
                            ]
                        }));
                    });
                    
                    return new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        borders: {
                            top: { style: BorderStyle.SINGLE, size: 2, color: "000000" },
                            bottom: { style: BorderStyle.SINGLE, size: 2, color: "000000" },
                            left: { style: BorderStyle.SINGLE, size: 2, color: "000000" },
                            right: { style: BorderStyle.SINGLE, size: 2, color: "000000" },
                            insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: "000000" },
                            insideVertical: { style: BorderStyle.SINGLE, size: 1, color: "000000" }
                        },
                        rows: rows
                    });
                }
                
                // Create document sections
                const sections = [
                    // Header
                    new Paragraph({
                        children: [
                            new TextRun({
                                text: "OFFSHORE HANDOVER NOTES",
                                bold: true,
                                size: 36,
                                color: "1E293B"
                            })
                        ],
                        heading: HeadingLevel.TITLE,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 200 }
                    }),
                    new Paragraph({
                        children: [
                            new TextRun({
                                text: "Crew Change Documentation System",
                                size: 24,
                                color: "64748B"
                            })
                        ],
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 400 }
                    }),
                    
                    // Info Table
                    new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        borders: {
                            top: { style: BorderStyle.SINGLE, size: 2 },
                            bottom: { style: BorderStyle.SINGLE, size: 2 },
                            left: { style: BorderStyle.SINGLE, size: 2 },
                            right: { style: BorderStyle.SINGLE, size: 2 },
                            insideHorizontal: { style: BorderStyle.SINGLE, size: 1 },
                            insideVertical: { style: BorderStyle.SINGLE, size: 1 }
                        },
                        rows: [
                            new TableRow({
                                children: [
                                    new TableCell({
                                        children: [new Paragraph({ 
                                            children: [new TextRun({ text: "From:", bold: true, size: 20 })] 
                                        })],
                                        width: { size: 15, type: WidthType.PERCENTAGE }
                                    }),
                                    new TableCell({
                                        children: [new Paragraph({ 
                                            children: [new TextRun({ text: data.fromPerson || "Abd Aziz Mohamad", size: 20 })] 
                                        })],
                                        width: { size: 35, type: WidthType.PERCENTAGE }
                                    }),
                                    new TableCell({
                                        children: [new Paragraph({ 
                                            children: [new TextRun({ text: "To:", bold: true, size: 20 })] 
                                        })],
                                        width: { size: 15, type: WidthType.PERCENTAGE }
                                    }),
                                    new TableCell({
                                        children: [new Paragraph({ 
                                            children: [new TextRun({ text: data.toPerson || "Mohammad Azam Abu Bakar", size: 20 })] 
                                        })],
                                        width: { size: 35, type: WidthType.PERCENTAGE }
                                    })
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        children: [new Paragraph({ 
                                            children: [new TextRun({ text: "Date:", bold: true, size: 20 })] 
                                        })],
                                        columnSpan: 1
                                    }),
                                    new TableCell({
                                        children: [new Paragraph({ 
                                            children: [new TextRun({ 
                                                text: `${formatDate(data.startDate)} ‚Äî ${formatDate(data.endDate)}`, 
                                                size: 20 
                                            })] 
                                        })],
                                        columnSpan: 3
                                    })
                                ]
                            })
                        ]
                    }),
                    
                    new Paragraph({
                        children: [
                            new TextRun({
                                text: "Note: This hand-over format must not be altered without System Administrator's approval.",
                                italics: true,
                                size: 16,
                                color: "64748B"
                            })
                        ],
                        alignment: AlignmentType.CENTER,
                        spacing: { before: 400, after: 400 }
                    }),
                    
                    // 1. SHE Section
                    new Paragraph({
                        children: [new TextRun({ text: "1. Safety, Health and Environment (SHE)", bold: true, size: 28 })],
                        heading: HeadingLevel.HEADING_1,
                        spacing: { before: 400, after: 200 }
                    })
                ];
                
                // SHE Table Data
                const sheBodyData = [
                    ['1.', `SHE & Health Issues:\n${data.sheData.sheHealth || 'No issues reported during this hitch.'}`, ''],
                    ['', `Scenario Management Safeguard:\n${data.sheData.scenarioManagement || 'All safeguards in place.'}`, ''],
                    ['', `HCR/NM/Security/DOSS:\n${data.sheData.hcrNmSecurity || 'No incidents reported.'}`, ''],
                    ['2.', `Safety Meeting/Drill/BeOb/Safety Alert:\n${data.sheData.safetyMeeting || 'All meetings conducted.'}`, '']
                ];
                if (data.sheData.additional && data.sheData.additional.length > 0) {
                    data.sheData.additional.forEach((comment, index) => {
                        const label = data.sheData.additional.length === 1 ? 'Additional Comments' : `Additional Comment ${index + 1}`;
                        sheBodyData.push(['', `${label}:\n${comment}`, '']);
                    });
                }
                
                sections.push(createSectionTable(sheBodyData));
                sections.push(new Paragraph({ children: [], spacing: { after: 400 } }));
                
                // 2. Integrity Section
                sections.push(new Paragraph({
                    children: [new TextRun({ text: "2. Integrity", bold: true, size: 28 })],
                    heading: HeadingLevel.HEADING_1,
                    spacing: { before: 200, after: 200 }
                }));
                
                const integrityBodyData = [
                    ['1.', data.integrity || 'Refer PMET & IPSS system. All systems functioning within parameters.', '']
                ];
                if (data.integrityAdditional && data.integrityAdditional.length > 0) {
                    data.integrityAdditional.forEach((comment, index) => {
                        const label = data.integrityAdditional.length === 1 ? 'Additional Comments' : `Additional Comment ${index + 1}`;
                        integrityBodyData.push(['', `${label}:\n${comment}`, '']);
                    });
                }
                
                sections.push(createSectionTable(integrityBodyData));
                sections.push(new Paragraph({ children: [], spacing: { after: 400 } }));
                
                // 3. Equipment Section
                sections.push(new Paragraph({
                    children: [new TextRun({ text: "3. Major Equipment Issues", bold: true, size: 28 })],
                    heading: HeadingLevel.HEADING_1,
                    spacing: { before: 200, after: 200 }
                }));
                
                const equipmentBodyData = [];
                let counter = 1;
                const equipmentCategories = {
                    'MOL pumps': data.equipment.filter(item => item.label.startsWith('P-160')),
                    'Generator': data.equipment.filter(item => item.label.startsWith('TG-') || item.label.includes('Gen')),
                    'Gas Compressor': data.equipment.filter(item => item.label.startsWith('SK-')),
                    'Cranes': data.equipment.filter(item => item.label.includes('ME-')),
                    'Fire Water Pumps': data.equipment.filter(item => item.label.startsWith('P-590')),
                    'Utility': data.equipment.filter(item => 
                        !item.label.startsWith('P-160') && 
                        !item.label.startsWith('TG-') && 
                        !item.label.includes('Gen') && 
                        !item.label.startsWith('SK-') && 
                        !item.label.startsWith('P-590') && 
                        !item.label.includes('ME-')
                    )
                };
                
                Object.entries(equipmentCategories).forEach(([categoryName, items]) => {
                    if (items.length > 0) {
                        equipmentBodyData.push([`${counter}.`, categoryName, '']);
                        items.forEach(item => {
                            equipmentBodyData.push(['', `${item.label}: ${item.status}${item.comment ? ` (${item.comment})` : ''}`, '']);
                        });
                        counter++;
                    }
                });
                
                sections.push(createSectionTable(equipmentBodyData));
                sections.push(new Paragraph({ children: [], spacing: { after: 400 } }));
                
                // Continue with remaining sections 4-11
                const remainingSections = [
                    { 
						title: "4. Operations", 
						data: (() => {
							const operationsData = [
								['1.', `General Operations:\n${data.generalOperations || 'Operations continuing as per program.'}`, '']
							];
							
							// Add Operation Issues if exists
							if (data.operationIssuesFromOps) {
								operationsData.push(['', `Operation Issues:\n${data.operationIssuesFromOps}`, '']);
							}
							
							// Add Field Changes if exists
							if (data.fieldChangesFromOps) {
								operationsData.push(['', `Field Changes:\n${data.fieldChangesFromOps}`, '']);
							}
							
							// Add Pigging Activities
							operationsData.push(['', 'Pigging Activities:', '']);
							data.pigging.forEach(pig => {
								operationsData.push(['', `${pig.title}: Last: ${pig.lastLaunch || 'TBD'}, Next: ${pig.nextDue || 'TBD'}`, '']);
							});
							
							return operationsData;
						})(),
						additional: data.operationsAdditional
					},
                    { 
                        title: "5. Work Management", 
                        data: [['1.', data.workManagement || 'All activities proceeding as planned.', '']],
                        additional: data.workAdditional
                    },
                    { 
                        title: "6. Safety Systems Defeated", 
                        data: [['1.', data.safetySystemsText || 'No systems defeated.', '']],
                        additional: data.safetyAdditional
                    },
                    { 
                        title: "7. Production Issues", 
                        data: [['1.', `Wells Status: ${data.production.wellsStatus || 'Operating normally'}`, '']],
                        additional: data.production.additional
                    },
                    { 
                        title: "8. Maintenance", 
                        data: [['1.', data.maintenance || 'All activities on schedule.', '']],
                        additional: data.maintenanceAdditional
                    },
                    { 
                        title: "9. SIMOPS", 
                        data: [['1.', data.simops || 'No operations planned.', '']],
                        additional: data.simopsAdditional
                    },
                    { 
                        title: "10. Administration", 
                        data: [['1.', data.administration || 'No new directives.', '']],
                        additional: data.adminAdditional
                    },
                    { 
                        title: "11. Alarm Management", 
                        data: [['1.', data.alarmManagement || 'All systems functioning.', '']],
                        additional: data.alarmAdditional
                    }
                ];
                
                remainingSections.forEach(section => {
                    sections.push(new Paragraph({
                        children: [new TextRun({ text: section.title, bold: true, size: 28 })],
                        heading: HeadingLevel.HEADING_1,
                        spacing: { before: 200, after: 200 }
                    }));
                    
                    // Add additional comments to section data if they exist
                    const sectionDataWithComments = [...section.data];
                    if (section.additional && section.additional.length > 0) {
                        section.additional.forEach((comment, index) => {
                            const label = section.additional.length === 1 ? 'Additional Comments' : `Additional Comment ${index + 1}`;
                            sectionDataWithComments.push(['', `${label}:\n${comment}`, '']);
                        });
                    }
                    
                    sections.push(createSectionTable(sectionDataWithComments));
                    sections.push(new Paragraph({ children: [], spacing: { after: 400 } }));
                });

                // Create document with proper spacing and formatting
                const doc = new Document({
                    sections: [{
                        properties: {
                            page: {
                                margin: {
                                    top: 720,    // 0.5 inch
                                    right: 720,
                                    bottom: 720,
                                    left: 720
                                }
                            }
                        },
                        children: sections
                    }]
                });

                // Generate and download
                Packer.toBlob(doc).then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Enhanced_Handover_${data.startDate || 'Current'}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showNotification('Enhanced Word document generated with proper table formatting!', 'success');
                }).catch(error => {
                    console.error('Word generation error:', error);
                    showNotification('Error generating Word document: ' + error.message, 'error');
                });
                
            } catch (error) {
                console.error('Word generation error:', error);
                showNotification('Error generating Word document: ' + error.message, 'error');
            }
        }

		function downloadTXT() {
			try {
				const rawData = collectAllData();      // ‚úÖ Changed: data ‚Üí rawData
				const data = autoCleanData(rawData);   // ‚úÖ Now this works!
                const startDate = formatDate(data.startDate);
                const endDate = formatDate(data.endDate);
                
                let content = `From: ${data.fromPerson}
Date: ${startDate} ‚Äî ${endDate}
To: ${data.toPerson}

Note: This hand-over format must not be altered without System Administrator's approval.

========================================================================================
1. SAFETY, HEALTH AND ENVIRONMENT (SHE)
========================================================================================

SHE & Health Issues:
${data.sheData.sheHealth || 'No issues reported during this hitch.'}

Scenario Management Safeguard:
${data.sheData.scenarioManagement || 'All scenario management safeguards in place.'}

HCR/NM/Security/DOSS/Others:
${data.sheData.hcrNmSecurity || 'No incidents reported.'}

Safety Meeting / Drill / BeOb / Safety Alert:
${data.sheData.safetyMeeting || 'All meetings conducted as scheduled.'}

`;

                if (data.sheData.additional && data.sheData.additional.length > 0) {
                    data.sheData.additional.forEach((comment, index) => {
                        const label = data.sheData.additional.length === 1 ? 'Additional Comments' : `Additional Comment ${index + 1}`;
                        content += `${label}:\n${comment}\n\n`;
                    });
                }

                content += `========================================================================================
2. INTEGRITY
========================================================================================

${data.integrity || 'Refer PMET & IPSS system. All systems functioning within parameters.'}

`;

                if (data.integrityAdditional && data.integrityAdditional.length > 0) {
                    data.integrityAdditional.forEach((comment, index) => {
                        const label = data.integrityAdditional.length === 1 ? 'Additional Comments' : `Additional Comment ${index + 1}`;
                        content += `${label}:\n${comment}\n\n`;
                    });
                }

                content += `========================================================================================
3. MAJOR EQUIPMENT ISSUES
========================================================================================

Equipment Status:
`;

                // Add equipment data with better formatting
                const categories = ['MOL pumps', 'Generator', 'Gas Compressor', 'Cranes', 'Fire Water Pumps', 'Utility'];
                
                categories.forEach(category => {
                    let categoryEquipment = [];
                    
                    data.equipment.forEach(item => {
                        let itemCategory = 'Utility';
                        if (item.label.startsWith('P-160')) itemCategory = 'MOL pumps';
                        else if (item.label.startsWith('TG-') || item.label.includes('Gen')) itemCategory = 'Generator';
                        else if (item.label.startsWith('SK-')) itemCategory = 'Gas Compressor';
                        else if (item.label.includes('ME-')) itemCategory = 'Cranes';
                        else if (item.label.startsWith('P-590')) itemCategory = 'Fire Water Pumps';
                        
                        if (itemCategory === category) {
                            categoryEquipment.push(item);
                        }
                    });
                    
                    if (categoryEquipment.length > 0) {
                        content += `\n${category.toUpperCase()}:\n`;
                        content += `${'‚îÄ'.repeat(40)}\n`;
                        categoryEquipment.forEach(item => {
                            content += `‚Ä¢ ${item.label}: ${item.status}`;
                            if (item.comment) content += ` (${item.comment})`;
                            content += `\n`;
                        });
                    }
                });

                // Continue with remaining sections with better formatting
				content += `
========================================================================================
4. OPERATIONS
========================================================================================

General Operations Information:
${data.generalOperations || 'Operations continuing as per program.'}
`;

				// Add Operation Issues if exists
				if (data.operationIssuesFromOps) {
					content += `\nOperation Issues:\n${'‚îÄ'.repeat(40)}\n${data.operationIssuesFromOps}\n`;
				}

				// Add Field Changes if exists
				if (data.fieldChangesFromOps) {
					content += `\nField Changes:\n${'‚îÄ'.repeat(40)}\n${data.fieldChangesFromOps}\n`;
				}

				content += `\nPigging Activities and Schedule:\n${'‚îÄ'.repeat(40)}\n`;

				data.pigging.forEach(pig => {
					content += `‚Ä¢ ${pig.title}:\n  Last Launch: ${pig.lastLaunch || 'TBD'}\n  Next Due: ${pig.nextDue || 'TBD'}\n\n`;
				});

                const txtSections = [
                    { title: "5. WORK MANAGEMENT", content: data.workManagement || 'All work management activities proceeding as planned.', additional: data.workAdditional },
                    { title: "6. SAFETY SYSTEMS DEFEATED", content: data.safetySystemsText || 'No safety systems currently defeated.', additional: data.safetyAdditional },
                    { title: "7. PRODUCTION ISSUES", content: `Wells Status: ${data.production.wellsStatus || 'All wells operating normally.'}`, additional: data.production.additional },
                    { title: "8. MAINTENANCE", content: data.maintenance || 'All maintenance activities on schedule.', additional: data.maintenanceAdditional },
                    { title: "9. SIMOPS", content: data.simops || 'No simultaneous operations planned.', additional: data.simopsAdditional },
                    { title: "10. ADMINISTRATION", content: data.administration || 'No new directives received.', additional: data.adminAdditional },
                    { title: "11. ALARM MANAGEMENT", content: data.alarmManagement || 'All alarm systems functioning properly.', additional: data.alarmAdditional }
                ];

                txtSections.forEach(section => {
                    content += `

========================================================================================
${section.title}
========================================================================================

${section.content}
`;
                    if (section.additional && section.additional.length > 0) {
                        content += `\n`;
                        section.additional.forEach((comment, index) => {
                            const label = section.additional.length === 1 ? 'Additional Comments' : `Additional Comment ${index + 1}`;
                            content += `${label}:\n${comment}\n\n`;
                        });
                    }
                });

                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Enhanced_Handover_${data.startDate || 'Current'}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('Enhanced TXT file downloaded successfully!', 'success');
            } catch (error) {
                showNotification('Error downloading file: ' + error.message, 'error');
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
		
function syncFromEquipmentDashboard() {
    try {
        // Get master data from localStorage
        const masterDataStr = localStorage.getItem('masterEquipmentData');
        
        if (!masterDataStr) {
            showNotification('‚ùå No equipment data found! Please open Key Equipment Dashboard first.', 'error');
            return;
        }
        
        const masterData = JSON.parse(masterDataStr);
        const syncTime = new Date(masterData.timestamp).toLocaleString();
        
        // Confirm with user
        const confirmMsg = `Sync equipment data from:\n${syncTime}\n\nThis will update all equipment status. Continue?`;
        if (!confirm(confirmMsg)) {
            return;
        }
        
        // FIXED: Complete status mapping - key_equipment ‚Üí handover
        const statusMap = {
            'running': 'Online',        // NEW: Added mapping for running
            'available': 'Available',
            'unavailable': 'Not Available',
            'deficient': 'Deficient'
        };
        
        let syncCount = 0;
        let notFoundCount = 0;
        const notFoundList = [];
        
        // Update each equipment in handover
        masterData.equipment.forEach(masterEquip => {
            let found = false;
            
            document.querySelectorAll('#equipment .equipment-row').forEach(row => {
                const label = row.querySelector('.equipment-label');
                if (!label) return;
                
                // IMPROVED: Better name cleaning and matching
                const handoverName = label.textContent
                    .replace(/[:]/g, '')  // Remove colon
                    .trim()
                    .toLowerCase();
                    
                const masterName = masterEquip.name
                    .replace(/[‚öôÔ∏èüîµüî¥‚ö†Ô∏èüíßüö®üî•üßØüóøüèóÔ∏è‚õΩüõ¢Ô∏è‚ùÑÔ∏è]/g, '')  // Remove ALL emojis
                    .trim()
                    .toLowerCase();
                
                // IMPROVED: Flexible matching - check if either contains the other
                const isMatch = handoverName.includes(masterName) || 
                               masterName.includes(handoverName) ||
                               // Try matching without spaces
                               handoverName.replace(/\s/g, '') === masterName.replace(/\s/g, '');
                
                if (isMatch) {
                    found = true;
                    
                    const statusSelect = row.querySelector('.status-select');
                    const commentInput = row.querySelector('.comment-input');
                    
                    if (statusSelect) {
                        // Map status from master to handover format
                        const mappedStatus = statusMap[masterEquip.status.toLowerCase()];
                        
                        if (mappedStatus) {
                            statusSelect.value = mappedStatus;
                            
                            // Update comment
                            if (commentInput) {
                                commentInput.value = masterEquip.comment || '';
                                
                                // Enable/disable comment based on status
                                if (mappedStatus === 'Available' || mappedStatus === 'Online') {
                                    commentInput.disabled = true;
                                    commentInput.style.backgroundColor = 'var(--slate-100)';
                                } else {
                                    commentInput.disabled = false;
                                    commentInput.style.backgroundColor = 'white';
                                }
                            }
                            
                            syncCount++;
                        } else {
                            console.warn(`‚ö†Ô∏è Unknown status: ${masterEquip.status} for ${masterEquip.name}`);
                        }
                    }
                }
            });
            
            if (!found) {
                notFoundCount++;
                notFoundList.push(masterEquip.name);
                console.log(`‚ö†Ô∏è Equipment not found in handover: ${masterEquip.name}`);
            }
        });
        
        // Update last sync time display
        document.getElementById('lastSyncTime').textContent = `Last synced: ${syncTime}`;
        
        // Show detailed notification
        let message = `‚úÖ Synced ${syncCount} equipment successfully!`;
        if (notFoundCount > 0) {
            message += `\n\n‚ö†Ô∏è ${notFoundCount} equipment not found in handover:`;
            notFoundList.slice(0, 5).forEach(name => {
                message += `\n‚Ä¢ ${name}`;
            });
            if (notFoundCount > 5) {
                message += `\n... and ${notFoundCount - 5} more`;
            }
        }
        
        showNotification(message, syncCount > 0 ? 'success' : 'error');
        
        console.log(`‚úÖ Sync completed: ${syncCount} synced, ${notFoundCount} not found`);
        if (notFoundList.length > 0) {
            console.log('Not found list:', notFoundList);
        }
        
    } catch (error) {
        console.error('Sync error:', error);
        showNotification('‚ùå Error syncing equipment: ' + error.message, 'error');
    }
}
        
        // Auto-check for master data on page load
        document.addEventListener('DOMContentLoaded', function() {
            const masterDataStr = localStorage.getItem('masterEquipmentData');
            if (masterDataStr) {
                try {
                    const masterData = JSON.parse(masterDataStr);
                    const syncTime = new Date(masterData.timestamp).toLocaleString();
                    document.getElementById('lastSyncTime').textContent = `Data available from: ${syncTime}`;
                } catch (error) {
                    console.error('Error reading master data:', error);
                }
            }

});

        // ========================================
        // AI ASSISTANT FUNCTIONS
        // ========================================

        function openAIAssistant() {
            document.getElementById('aiAssistantModal').classList.add('active');
            switchAITab('extract'); // Default to first tab
        }

        function closeAIAssistant() {
            document.getElementById('aiAssistantModal').classList.remove('active');
        }

        function switchAITab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.ai-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.ai-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            if (tabName === 'extract') {
                document.getElementById('aiExtractTab').style.display = 'block';
                document.querySelectorAll('.ai-tab-btn')[0].classList.add('active');
            } else if (tabName === 'refine') {
                document.getElementById('aiRefineTab').style.display = 'block';
                document.querySelectorAll('.ai-tab-btn')[1].classList.add('active');
                generateAIRefinePrompt(); // Auto-generate prompt
            } else if (tabName === 'email') {
                document.getElementById('aiEmailTab').style.display = 'block';
                document.querySelectorAll('.ai-tab-btn')[2].classList.add('active');
                generateAIHandoverPrompt(); // Auto-generate prompt
            }
        }

        // Handle JSON file upload
        document.addEventListener('DOMContentLoaded', function() {
            const jsonFileInput = document.getElementById('jsonFileInput');
            if (jsonFileInput) {
                jsonFileInput.addEventListener('change', handleJSONFileUpload);
            }

            // Close modal when clicking outside
            const aiModal = document.getElementById('aiAssistantModal');
            if (aiModal) {
                aiModal.addEventListener('click', function(e) {
                    if (e.target === aiModal) {
                        closeAIAssistant();
                    }
                });
            }
        });

        function handleJSONFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // Show preview
                    document.getElementById('jsonPreview').style.display = 'block';
                    document.getElementById('jsonPreviewText').textContent = JSON.stringify(jsonData, null, 2).substring(0, 500) + '...';
                    
                    // Generate AI prompt
                    generateAIExtractPromptWithJSON(jsonData);
                    
                    showNotification('‚úÖ JSON file loaded successfully!', 'success');
                } catch (error) {
                    showNotification('‚ùå Invalid JSON file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function generateAIExtractPromptWithJSON(jsonData) {
            const prompt = `Prompt To Extract Data dari Json File Read and ensure you fully understand this OIM Assist JSON and create a professional handover note in English combining IbA, IbB, and IbC. Make sure it sounds professional, human, and written in the voice of an experienced Offshore Installation Manager (OIM). The tone must show full control of the operation, clear communication, and be suitable for sharing with my counterpart or back to back. Make it concise, assertive, and structured. Avoid robotic or overly formal tone ‚Äì just confident and natural.

Format as:
1Ô∏è‚É£ General Operations Information ‚Äì three short paragraphs (~90 words each) summarizing everything related and start with SHE, Operation / Production, hi impact activity etc..
2Ô∏è‚É£ Operation Issues ‚Äì bullet points for shortfalls, ESDs, or reliability concerns. Start with date it happen
3Ô∏è‚É£ Field Changes ‚Äì bullet points for repairs, commissioning, replacements, or ongoing works. Start with date it happen
4Ô∏è‚É£ Hitch Activities (2-Week Summary) ‚Äì Generate Hitch Activities (whole json file) with each workgroup in bold and 3 concise bullet points summarising all key activities for that group based on the JSON data.

Keep tone calm, factual, and OIM-style. Avoid symbols like "‚Äî" or ";". Use markdown headings and concise wording. Skip missing data.

JSON Data:
${JSON.stringify(jsonData, null, 2)}`;

            document.getElementById('aiExtractPrompt').value = prompt;
        }

        function useCurrentSystemData() {
            const data = collectAllData();
            
            // Build comprehensive summary from all sections
            let summary = '';
            
            // SHE Section
            if (data.sheData.sheHealth || data.sheData.scenarioManagement || data.sheData.hcrNmSecurity || data.sheData.safetyMeeting) {
                summary += '=== SAFETY, HEALTH AND ENVIRONMENT ===\n\n';
                if (data.sheData.sheHealth) summary += `SHE & Health Issues:\n${data.sheData.sheHealth}\n\n`;
                if (data.sheData.scenarioManagement) summary += `Scenario Management:\n${data.sheData.scenarioManagement}\n\n`;
                if (data.sheData.hcrNmSecurity) summary += `HCR/NM/Security:\n${data.sheData.hcrNmSecurity}\n\n`;
                if (data.sheData.safetyMeeting) summary += `Safety Meeting/Drill:\n${data.sheData.safetyMeeting}\n\n`;
            }
            
            // Integrity
            if (data.integrity) {
                summary += '=== INTEGRITY ===\n\n';
                summary += data.integrity + '\n\n';
            }
            
            // Equipment
            if (data.equipment && data.equipment.length > 0) {
                summary += '=== MAJOR EQUIPMENT STATUS ===\n\n';
                const equipmentByStatus = data.equipment.filter(e => e.status !== 'Available' && e.status !== 'Online');
                if (equipmentByStatus.length > 0) {
                    equipmentByStatus.forEach(eq => {
                        summary += `‚Ä¢ ${eq.label}: ${eq.status}`;
                        if (eq.comment) summary += ` - ${eq.comment}`;
                        summary += '\n';
                    });
                    summary += '\n';
                } else {
                    summary += 'All major equipment available and operational.\n\n';
                }
            }
            
            // Operations
            if (data.generalOperations) {
                summary += '=== OPERATIONS ===\n\n';
                summary += data.generalOperations + '\n\n';
            }
            
            // Operation Issues (from sync)
            if (data.operationIssuesFromOps) {
                summary += '=== OPERATION ISSUES ===\n\n';
                summary += data.operationIssuesFromOps + '\n\n';
            }
            
            // Field Changes (from sync)
            if (data.fieldChangesFromOps) {
                summary += '=== FIELD CHANGES ===\n\n';
                summary += data.fieldChangesFromOps + '\n\n';
            }
            
            // Pigging
            if (data.pigging && data.pigging.length > 0) {
                summary += '=== PIGGING ACTIVITIES ===\n\n';
                data.pigging.forEach(pig => {
                    summary += `‚Ä¢ ${pig.title}\n`;
                    if (pig.lastLaunch) summary += `  Last: ${pig.lastLaunch}\n`;
                    if (pig.nextDue) summary += `  Next: ${pig.nextDue}\n`;
                });
                summary += '\n';
            }
            
            // Work Management
            if (data.workManagement) {
                summary += '=== WORK MANAGEMENT ===\n\n';
                summary += data.workManagement + '\n\n';
            }
            
            // Safety Defeats
            if (data.defeats && data.defeats.length > 0) {
                summary += '=== SAFETY SYSTEMS DEFEATED ===\n\n';
                data.defeats.forEach((defeat, index) => {
                    summary += `${index + 1}. ${defeat.description}\n`;
                    if (defeat.defeatDate) summary += `   Defeated: ${defeat.defeatDate}\n`;
                    if (defeat.dueDate) summary += `   Due: ${defeat.dueDate}\n`;
                    if (defeat.approval) summary += `   Approval: ${defeat.approval}\n`;
                });
                summary += '\n';
            } else if (data.safetySystemsText) {
                summary += '=== SAFETY SYSTEMS ===\n\n';
                summary += data.safetySystemsText + '\n\n';
            }
            
            // Production
            if (data.production.sdcValue || data.production.wellsStatus) {
                summary += '=== PRODUCTION ===\n\n';
                if (data.production.sdcValue) {
                    summary += `SDC Target: ${data.production.sdcValue} kl/d`;
                    if (data.production.sdcDate) summary += ` (${data.production.sdcDate})`;
                    summary += '\n';
                }
                if (data.production.wellsStatus) summary += `Wells: ${data.production.wellsStatus}\n`;
                summary += '\n';
            }
            
            // Maintenance
            if (data.maintenance) {
                summary += '=== MAINTENANCE ===\n\n';
                summary += data.maintenance + '\n\n';
            }
            
            // SIMOPS
            if (data.simops) {
                summary += '=== SIMOPS ===\n\n';
                summary += data.simops + '\n\n';
            }
            
            // Administration
            if (data.administration) {
                summary += '=== ADMINISTRATION ===\n\n';
                summary += data.administration + '\n\n';
            }
            
            // Alarm Management
            if (data.alarmManagement) {
                summary += '=== ALARM MANAGEMENT ===\n\n';
                summary += data.alarmManagement + '\n\n';
            }
            
            // Populate the appropriate field based on active tab
            const refineTextarea = document.getElementById('textToRefine');
            const emailTextarea = document.getElementById('emailSummary');
            
            if (refineTextarea && refineTextarea.closest('.ai-tab-content').style.display !== 'none') {
                refineTextarea.value = summary;
                generateAIRefinePrompt();
            }
            
            if (emailTextarea && emailTextarea.closest('.ai-tab-content').style.display !== 'none') {
                emailTextarea.value = summary;
                generateAIHandoverPrompt();
            }
            
            showNotification('‚úÖ System data extracted successfully!', 'success');
        }

        function generateAIRefinePrompt() {
            const textToRefine = document.getElementById('textToRefine').value;
            
            const prompt = `Please refine my writing below so that it sounds professional, human, and written in the voice of an experienced Offshore Installation Manager (OIM). The tone must show full control of the operation, clear communication, and be suitable for sharing with my counterpart or back to back. Make it concise, assertive, and structured. Avoid robotic or overly formal tone ‚Äì just confident and natural.

${textToRefine}`;

            document.getElementById('aiRefinePrompt').value = prompt;
        }

        function generateAIHandoverPrompt() {
            const emailSummary = document.getElementById('emailSummary').value;
            
            const prompt = `Base on attach file, read and understand it than write a professional and natural handover email from Aziz (OIM) to Azam based on the attached summary. Make sure it sounds professional, human, and written in the voice of an experienced Offshore Installation Manager (OIM). The tone must show full control of the operation, clear communication, and be suitable for sharing with my counterpart or back to back. Make it concise, assertive, and structured. Avoid robotic or overly formal tone ‚Äì just confident and natural.

Start with:
"Assalamualaikum Azam,"
then a short wish like:
"Hope all is well and wishing you a smooth hitch ahead."

Summarize overall status (safe, stable, ready), then list
**Key Focus Areas:** using bullet points (‚Ä¢) for main items or follow-ups.

Keep tone confident, clear, and human (experienced OIM voice).
Avoid semicolons and em dashes.

End with:
"All details are attached. Reach out anytime if needed. Take care and safe operation."

Handover Summary:
${emailSummary}`;

            document.getElementById('aiEmailPrompt').value = prompt;
        }

        function copyToClipboard(elementId) {
            const textarea = document.getElementById(elementId);
            if (!textarea || !textarea.value) {
                showNotification('‚ùå No prompt to copy!', 'error');
                return;
            }

            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile

            try {
                document.execCommand('copy');
                showNotification('‚úÖ Prompt copied to clipboard! Paste it in ChatGPT/Claude.', 'success');
            } catch (err) {
                // Fallback for modern browsers
                navigator.clipboard.writeText(textarea.value).then(() => {
                    showNotification('‚úÖ Prompt copied to clipboard! Paste it in ChatGPT/Claude.', 'success');
                }).catch(() => {
                    showNotification('‚ùå Failed to copy. Please copy manually.', 'error');
                });
            }
        }

        // Auto-update prompts when text changes
        document.addEventListener('DOMContentLoaded', function() {
            const textToRefine = document.getElementById('textToRefine');
            const emailSummary = document.getElementById('emailSummary');

            if (textToRefine) {
                textToRefine.addEventListener('input', generateAIRefinePrompt);
            }

            if (emailSummary) {
                emailSummary.addEventListener('input', generateAIHandoverPrompt);
            }
        });
    </script>
</body>
</html>